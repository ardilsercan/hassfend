{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/helpers/regeneratorRuntime\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/asyncToGenerator\";\nimport \"core-js/modules/es.array.concat.js\";\nimport \"core-js/modules/es.object.assign.js\";\nimport \"core-js/modules/es.string.starts-with.js\";\nimport { timeCacheEntityPromiseFunc } from \"../common/util/time-cache-entity-promise-func\";\nimport { getSignedPath } from \"./auth\";\nexport var CAMERA_ORIENTATIONS = [1, 2, 3, 4, 6, 8];\nexport var CAMERA_SUPPORT_ON_OFF = 1;\nexport var CAMERA_SUPPORT_STREAM = 2;\nexport var STREAM_TYPE_HLS = \"hls\";\nexport var STREAM_TYPE_WEB_RTC = \"web_rtc\";\nexport var cameraUrlWithWidthHeight = function cameraUrlWithWidthHeight(base_url, width, height) {\n  return \"\".concat(base_url, \"&width=\").concat(width, \"&height=\").concat(height);\n};\nexport var computeMJPEGStreamUrl = function computeMJPEGStreamUrl(entity) {\n  return \"/api/camera_proxy_stream/\".concat(entity.entity_id, \"?token=\").concat(entity.attributes.access_token);\n};\nexport var fetchThumbnailUrlWithCache = /*#__PURE__*/function () {\n  var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee(hass, entityId, width, height) {\n    var base_url;\n    return _regeneratorRuntime().wrap(function _callee$(_context) {\n      while (1) switch (_context.prev = _context.next) {\n        case 0:\n          _context.next = 2;\n          return timeCacheEntityPromiseFunc(\"_cameraTmbUrl\", 9000, fetchThumbnailUrl, hass, entityId);\n        case 2:\n          base_url = _context.sent;\n          return _context.abrupt(\"return\", cameraUrlWithWidthHeight(base_url, width, height));\n        case 4:\n        case \"end\":\n          return _context.stop();\n      }\n    }, _callee);\n  }));\n  return function fetchThumbnailUrlWithCache(_x, _x2, _x3, _x4) {\n    return _ref.apply(this, arguments);\n  };\n}();\nexport var fetchThumbnailUrl = /*#__PURE__*/function () {\n  var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee2(hass, entityId) {\n    var path;\n    return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n      while (1) switch (_context2.prev = _context2.next) {\n        case 0:\n          _context2.next = 2;\n          return getSignedPath(hass, \"/api/camera_proxy/\".concat(entityId));\n        case 2:\n          path = _context2.sent;\n          return _context2.abrupt(\"return\", hass.hassUrl(path.path));\n        case 4:\n        case \"end\":\n          return _context2.stop();\n      }\n    }, _callee2);\n  }));\n  return function fetchThumbnailUrl(_x5, _x6) {\n    return _ref2.apply(this, arguments);\n  };\n}();\nexport var fetchStreamUrl = /*#__PURE__*/function () {\n  var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee3(hass, entityId, format) {\n    var data, stream;\n    return _regeneratorRuntime().wrap(function _callee3$(_context3) {\n      while (1) switch (_context3.prev = _context3.next) {\n        case 0:\n          data = {\n            type: \"camera/stream\",\n            entity_id: entityId\n          };\n          if (format) {\n            // @ts-ignore\n            data.format = format;\n          }\n          _context3.next = 4;\n          return hass.callWS(data);\n        case 4:\n          stream = _context3.sent;\n          stream.url = hass.hassUrl(stream.url);\n          return _context3.abrupt(\"return\", stream);\n        case 7:\n        case \"end\":\n          return _context3.stop();\n      }\n    }, _callee3);\n  }));\n  return function fetchStreamUrl(_x7, _x8, _x9) {\n    return _ref3.apply(this, arguments);\n  };\n}();\nexport var handleWebRtcOffer = function handleWebRtcOffer(hass, entityId, offer) {\n  return hass.callWS({\n    type: \"camera/web_rtc_offer\",\n    entity_id: entityId,\n    offer: offer\n  });\n};\nexport var fetchCameraPrefs = function fetchCameraPrefs(hass, entityId) {\n  return hass.callWS({\n    type: \"camera/get_prefs\",\n    entity_id: entityId\n  });\n};\nexport var updateCameraPrefs = function updateCameraPrefs(hass, entityId, prefs) {\n  return hass.callWS(Object.assign({\n    type: \"camera/update_prefs\",\n    entity_id: entityId\n  }, prefs));\n};\nvar CAMERA_MEDIA_SOURCE_PREFIX = \"media-source://camera/\";\nexport var isCameraMediaSource = function isCameraMediaSource(mediaContentId) {\n  return mediaContentId.startsWith(CAMERA_MEDIA_SOURCE_PREFIX);\n};\nexport var getEntityIdFromCameraMediaSource = function getEntityIdFromCameraMediaSource(mediaContentId) {\n  return mediaContentId.substring(CAMERA_MEDIA_SOURCE_PREFIX.length);\n};","map":{"version":3,"names":["timeCacheEntityPromiseFunc","getSignedPath","CAMERA_ORIENTATIONS","CAMERA_SUPPORT_ON_OFF","CAMERA_SUPPORT_STREAM","STREAM_TYPE_HLS","STREAM_TYPE_WEB_RTC","cameraUrlWithWidthHeight","base_url","width","height","concat","computeMJPEGStreamUrl","entity","entity_id","attributes","access_token","fetchThumbnailUrlWithCache","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","hass","entityId","wrap","_callee$","_context","prev","next","fetchThumbnailUrl","sent","abrupt","stop","_x","_x2","_x3","_x4","apply","arguments","_ref2","_callee2","path","_callee2$","_context2","hassUrl","_x5","_x6","fetchStreamUrl","_ref3","_callee3","format","data","stream","_callee3$","_context3","type","callWS","url","_x7","_x8","_x9","handleWebRtcOffer","offer","fetchCameraPrefs","updateCameraPrefs","prefs","Object","assign","CAMERA_MEDIA_SOURCE_PREFIX","isCameraMediaSource","mediaContentId","startsWith","getEntityIdFromCameraMediaSource","substring","length"],"sources":["/workspaces/frontend/src/data/camera.ts"],"sourcesContent":["import {\n  HassEntityAttributeBase,\n  HassEntityBase,\n} from \"home-assistant-js-websocket\";\nimport { timeCacheEntityPromiseFunc } from \"../common/util/time-cache-entity-promise-func\";\nimport { HomeAssistant } from \"../types\";\nimport { getSignedPath } from \"./auth\";\n\nexport const CAMERA_ORIENTATIONS = [1, 2, 3, 4, 6, 8];\nexport const CAMERA_SUPPORT_ON_OFF = 1;\nexport const CAMERA_SUPPORT_STREAM = 2;\n\nexport const STREAM_TYPE_HLS = \"hls\";\nexport const STREAM_TYPE_WEB_RTC = \"web_rtc\";\n\ninterface CameraEntityAttributes extends HassEntityAttributeBase {\n  model_name: string;\n  access_token: string;\n  brand: string;\n  motion_detection: boolean;\n  frontend_stream_type: string;\n}\n\nexport interface CameraEntity extends HassEntityBase {\n  attributes: CameraEntityAttributes;\n}\n\nexport interface CameraPreferences {\n  preload_stream: boolean;\n  orientation: number;\n}\n\nexport interface CameraThumbnail {\n  content_type: string;\n  content: string;\n}\n\nexport interface Stream {\n  url: string;\n}\n\nexport interface WebRtcAnswer {\n  answer: string;\n}\n\nexport const cameraUrlWithWidthHeight = (\n  base_url: string,\n  width: number,\n  height: number\n) => `${base_url}&width=${width}&height=${height}`;\n\nexport const computeMJPEGStreamUrl = (entity: CameraEntity) =>\n  `/api/camera_proxy_stream/${entity.entity_id}?token=${entity.attributes.access_token}`;\n\nexport const fetchThumbnailUrlWithCache = async (\n  hass: HomeAssistant,\n  entityId: string,\n  width: number,\n  height: number\n) => {\n  const base_url = await timeCacheEntityPromiseFunc(\n    \"_cameraTmbUrl\",\n    9000,\n    fetchThumbnailUrl,\n    hass,\n    entityId\n  );\n  return cameraUrlWithWidthHeight(base_url, width, height);\n};\n\nexport const fetchThumbnailUrl = async (\n  hass: HomeAssistant,\n  entityId: string\n) => {\n  const path = await getSignedPath(hass, `/api/camera_proxy/${entityId}`);\n  return hass.hassUrl(path.path);\n};\n\nexport const fetchStreamUrl = async (\n  hass: HomeAssistant,\n  entityId: string,\n  format?: \"hls\"\n) => {\n  const data = {\n    type: \"camera/stream\",\n    entity_id: entityId,\n  };\n  if (format) {\n    // @ts-ignore\n    data.format = format;\n  }\n  const stream = await hass.callWS<Stream>(data);\n  stream.url = hass.hassUrl(stream.url);\n  return stream;\n};\n\nexport const handleWebRtcOffer = (\n  hass: HomeAssistant,\n  entityId: string,\n  offer: string\n) =>\n  hass.callWS<WebRtcAnswer>({\n    type: \"camera/web_rtc_offer\",\n    entity_id: entityId,\n    offer: offer,\n  });\n\nexport const fetchCameraPrefs = (hass: HomeAssistant, entityId: string) =>\n  hass.callWS<CameraPreferences>({\n    type: \"camera/get_prefs\",\n    entity_id: entityId,\n  });\n\ntype ValueOf<T extends any[]> = T[number];\nexport const updateCameraPrefs = (\n  hass: HomeAssistant,\n  entityId: string,\n  prefs: {\n    preload_stream?: boolean;\n    orientation?: ValueOf<typeof CAMERA_ORIENTATIONS>;\n  }\n) =>\n  hass.callWS<CameraPreferences>({\n    type: \"camera/update_prefs\",\n    entity_id: entityId,\n    ...prefs,\n  });\n\nconst CAMERA_MEDIA_SOURCE_PREFIX = \"media-source://camera/\";\n\nexport const isCameraMediaSource = (mediaContentId: string) =>\n  mediaContentId.startsWith(CAMERA_MEDIA_SOURCE_PREFIX);\n\nexport const getEntityIdFromCameraMediaSource = (mediaContentId: string) =>\n  mediaContentId.substring(CAMERA_MEDIA_SOURCE_PREFIX.length);\n"],"mappings":";;;;;AAIA,SAASA,0BAA0B,QAAQ,+CAA+C;AAE1F,SAASC,aAAa,QAAQ,QAAQ;AAEtC,OAAO,IAAMC,mBAAmB,GAAG,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC;AACrD,OAAO,IAAMC,qBAAqB,GAAG,CAAC;AACtC,OAAO,IAAMC,qBAAqB,GAAG,CAAC;AAEtC,OAAO,IAAMC,eAAe,GAAG,KAAK;AACpC,OAAO,IAAMC,mBAAmB,GAAG,SAAS;AAgC5C,OAAO,IAAMC,wBAAwB,GAAG,SAA3BA,wBAAwBA,CACnCC,QAAgB,EAChBC,KAAa,EACbC,MAAc;EAAA,UAAAC,MAAA,CACRH,QAAQ,aAAAG,MAAA,CAAUF,KAAK,cAAAE,MAAA,CAAWD,MAAM;AAAA,CAAE;AAElD,OAAO,IAAME,qBAAqB,GAAG,SAAxBA,qBAAqBA,CAAIC,MAAoB;EAAA,mCAAAF,MAAA,CAC5BE,MAAM,CAACC,SAAS,aAAAH,MAAA,CAAUE,MAAM,CAACE,UAAU,CAACC,YAAY;AAAA,CAAE;AAExF,OAAO,IAAMC,0BAA0B;EAAA,IAAAC,IAAA,GAAAC,iBAAA,eAAAC,mBAAA,GAAAC,IAAA,CAAG,SAAAC,QACxCC,IAAmB,EACnBC,QAAgB,EAChBf,KAAa,EACbC,MAAc;IAAA,IAAAF,QAAA;IAAA,OAAAY,mBAAA,GAAAK,IAAA,UAAAC,SAAAC,QAAA;MAAA,kBAAAA,QAAA,CAAAC,IAAA,GAAAD,QAAA,CAAAE,IAAA;QAAA;UAAAF,QAAA,CAAAE,IAAA;UAAA,OAES7B,0BAA0B,CAC/C,eAAe,EACf,IAAI,EACJ8B,iBAAiB,EACjBP,IAAI,EACJC,QACF,CAAC;QAAA;UANKhB,QAAQ,GAAAmB,QAAA,CAAAI,IAAA;UAAA,OAAAJ,QAAA,CAAAK,MAAA,WAOPzB,wBAAwB,CAACC,QAAQ,EAAEC,KAAK,EAAEC,MAAM,CAAC;QAAA;QAAA;UAAA,OAAAiB,QAAA,CAAAM,IAAA;MAAA;IAAA,GAAAX,OAAA;EAAA,CACzD;EAAA,gBAdYL,0BAA0BA,CAAAiB,EAAA,EAAAC,GAAA,EAAAC,GAAA,EAAAC,GAAA;IAAA,OAAAnB,IAAA,CAAAoB,KAAA,OAAAC,SAAA;EAAA;AAAA,GActC;AAED,OAAO,IAAMT,iBAAiB;EAAA,IAAAU,KAAA,GAAArB,iBAAA,eAAAC,mBAAA,GAAAC,IAAA,CAAG,SAAAoB,SAC/BlB,IAAmB,EACnBC,QAAgB;IAAA,IAAAkB,IAAA;IAAA,OAAAtB,mBAAA,GAAAK,IAAA,UAAAkB,UAAAC,SAAA;MAAA,kBAAAA,SAAA,CAAAhB,IAAA,GAAAgB,SAAA,CAAAf,IAAA;QAAA;UAAAe,SAAA,CAAAf,IAAA;UAAA,OAEG5B,aAAa,CAACsB,IAAI,uBAAAZ,MAAA,CAAuBa,QAAQ,CAAE,CAAC;QAAA;UAAjEkB,IAAI,GAAAE,SAAA,CAAAb,IAAA;UAAA,OAAAa,SAAA,CAAAZ,MAAA,WACHT,IAAI,CAACsB,OAAO,CAACH,IAAI,CAACA,IAAI,CAAC;QAAA;QAAA;UAAA,OAAAE,SAAA,CAAAX,IAAA;MAAA;IAAA,GAAAQ,QAAA;EAAA,CAC/B;EAAA,gBANYX,iBAAiBA,CAAAgB,GAAA,EAAAC,GAAA;IAAA,OAAAP,KAAA,CAAAF,KAAA,OAAAC,SAAA;EAAA;AAAA,GAM7B;AAED,OAAO,IAAMS,cAAc;EAAA,IAAAC,KAAA,GAAA9B,iBAAA,eAAAC,mBAAA,GAAAC,IAAA,CAAG,SAAA6B,SAC5B3B,IAAmB,EACnBC,QAAgB,EAChB2B,MAAc;IAAA,IAAAC,IAAA,EAAAC,MAAA;IAAA,OAAAjC,mBAAA,GAAAK,IAAA,UAAA6B,UAAAC,SAAA;MAAA,kBAAAA,SAAA,CAAA3B,IAAA,GAAA2B,SAAA,CAAA1B,IAAA;QAAA;UAERuB,IAAI,GAAG;YACXI,IAAI,EAAE,eAAe;YACrB1C,SAAS,EAAEU;UACb,CAAC;UACD,IAAI2B,MAAM,EAAE;YACV;YACAC,IAAI,CAACD,MAAM,GAAGA,MAAM;UACtB;UAACI,SAAA,CAAA1B,IAAA;UAAA,OACoBN,IAAI,CAACkC,MAAM,CAASL,IAAI,CAAC;QAAA;UAAxCC,MAAM,GAAAE,SAAA,CAAAxB,IAAA;UACZsB,MAAM,CAACK,GAAG,GAAGnC,IAAI,CAACsB,OAAO,CAACQ,MAAM,CAACK,GAAG,CAAC;UAAC,OAAAH,SAAA,CAAAvB,MAAA,WAC/BqB,MAAM;QAAA;QAAA;UAAA,OAAAE,SAAA,CAAAtB,IAAA;MAAA;IAAA,GAAAiB,QAAA;EAAA,CACd;EAAA,gBAhBYF,cAAcA,CAAAW,GAAA,EAAAC,GAAA,EAAAC,GAAA;IAAA,OAAAZ,KAAA,CAAAX,KAAA,OAAAC,SAAA;EAAA;AAAA,GAgB1B;AAED,OAAO,IAAMuB,iBAAiB,GAAG,SAApBA,iBAAiBA,CAC5BvC,IAAmB,EACnBC,QAAgB,EAChBuC,KAAa;EAAA,OAEbxC,IAAI,CAACkC,MAAM,CAAe;IACxBD,IAAI,EAAE,sBAAsB;IAC5B1C,SAAS,EAAEU,QAAQ;IACnBuC,KAAK,EAAEA;EACT,CAAC,CAAC;AAAA;AAEJ,OAAO,IAAMC,gBAAgB,GAAG,SAAnBA,gBAAgBA,CAAIzC,IAAmB,EAAEC,QAAgB;EAAA,OACpED,IAAI,CAACkC,MAAM,CAAoB;IAC7BD,IAAI,EAAE,kBAAkB;IACxB1C,SAAS,EAAEU;EACb,CAAC,CAAC;AAAA;AAGJ,OAAO,IAAMyC,iBAAiB,GAAG,SAApBA,iBAAiBA,CAC5B1C,IAAmB,EACnBC,QAAgB,EAChB0C,KAGC;EAAA,OAED3C,IAAI,CAACkC,MAAM,CAAAU,MAAA,CAAAC,MAAA;IACTZ,IAAI,EAAE,qBAAqB;IAC3B1C,SAAS,EAAEU;EAAQ,GAChB0C,KAAK,CACT,CAAC;AAAA;AAEJ,IAAMG,0BAA0B,GAAG,wBAAwB;AAE3D,OAAO,IAAMC,mBAAmB,GAAG,SAAtBA,mBAAmBA,CAAIC,cAAsB;EAAA,OACxDA,cAAc,CAACC,UAAU,CAACH,0BAA0B,CAAC;AAAA;AAEvD,OAAO,IAAMI,gCAAgC,GAAG,SAAnCA,gCAAgCA,CAAIF,cAAsB;EAAA,OACrEA,cAAc,CAACG,SAAS,CAACL,0BAA0B,CAACM,MAAM,CAAC;AAAA"},"metadata":{},"sourceType":"module","externalDependencies":[]}