{"ast":null,"code":"import _decorate from \"@babel/runtime/helpers/decorate\";\nimport _get from \"@babel/runtime/helpers/get\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/getPrototypeOf\";\nimport { LitElement, html, nothing } from \"lit\";\nimport { customElement, property, state } from \"lit/decorators\";\nimport { debounce } from \"../../../common/util/debounce\";\nimport { subscribePreviewTemplate } from \"../../../data/ws-templates\";\nimport \"./entity-preview-row\";\nimport { fireEvent } from \"../../../common/dom/fire_event\";\nlet FlowPreviewTemplate = _decorate([customElement(\"flow-preview-template\")], function (_initialize, _LitElement) {\n  class FlowPreviewTemplate extends _LitElement {\n    constructor(...args) {\n      super(...args);\n      _initialize(this);\n    }\n  }\n  return {\n    F: FlowPreviewTemplate,\n    d: [{\n      kind: \"field\",\n      decorators: [property({\n        attribute: false\n      })],\n      key: \"hass\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [property()],\n      key: \"flowType\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      key: \"handler\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [property()],\n      key: \"stepId\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [property()],\n      key: \"flowId\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [property({\n        attribute: false\n      })],\n      key: \"stepData\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [state()],\n      key: \"_preview\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [state()],\n      key: \"_listeners\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [state()],\n      key: \"_error\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      key: \"_unsub\",\n      value: void 0\n    }, {\n      kind: \"method\",\n      key: \"disconnectedCallback\",\n      value: function disconnectedCallback() {\n        _get(_getPrototypeOf(FlowPreviewTemplate.prototype), \"disconnectedCallback\", this).call(this);\n        if (this._unsub) {\n          this._unsub.then(unsub => unsub());\n          this._unsub = undefined;\n        }\n      }\n    }, {\n      kind: \"method\",\n      key: \"willUpdate\",\n      value: function willUpdate(changedProps) {\n        if (changedProps.has(\"stepData\")) {\n          this._debouncedSubscribePreview();\n        }\n      }\n    }, {\n      kind: \"method\",\n      key: \"render\",\n      value: function render() {\n        var _this$_listeners;\n        if (this._error) {\n          return html`<ha-alert alert-type=\"error\">${this._error}</ha-alert>`;\n        }\n        return html`<entity-preview-row\n        .hass=${this.hass}\n        .stateObj=${this._preview}\n      ></entity-preview-row>\n      ${(_this$_listeners = this._listeners) !== null && _this$_listeners !== void 0 && _this$_listeners.time ? html`\n            <p>\n              ${this.hass.localize(\"ui.dialogs.helper_settings.template.time\")}\n            </p>\n          ` : nothing}\n      ${!this._listeners ? nothing : this._listeners.all ? html`\n              <p class=\"all_listeners\">\n                ${this.hass.localize(\"ui.dialogs.helper_settings.template.all_listeners\")}\n              </p>\n            ` : this._listeners.domains.length || this._listeners.entities.length ? html`\n                <p>\n                  ${this.hass.localize(\"ui.dialogs.helper_settings.template.listeners\")}\n                </p>\n                <ul>\n                  ${this._listeners.domains.sort().map(domain => html`\n                        <li>\n                          <b\n                            >${this.hass.localize(\"ui.dialogs.helper_settings.template.domain\")}</b\n                          >: ${domain}\n                        </li>\n                      `)}\n                  ${this._listeners.entities.sort().map(entity_id => html`\n                        <li>\n                          <b\n                            >${this.hass.localize(\"ui.dialogs.helper_settings.template.entity\")}</b\n                          >: ${entity_id}\n                        </li>\n                      `)}\n                </ul>\n              ` : !this._listeners.time ? html`<p class=\"all_listeners\">\n                  ${this.hass.localize(\"ui.dialogs.helper_settings.template.no_listeners\")}\n                </p>` : nothing} `;\n      }\n    }, {\n      kind: \"field\",\n      key: \"_setPreview\",\n      value() {\n        return preview => {\n          if (\"error\" in preview) {\n            this._error = preview.error;\n            this._preview = undefined;\n            return;\n          }\n          this._error = undefined;\n          this._listeners = preview.listeners;\n          const now = new Date().toISOString();\n          this._preview = {\n            entity_id: `${this.stepId}.___flow_preview___`,\n            last_changed: now,\n            last_updated: now,\n            context: {\n              id: \"\",\n              parent_id: null,\n              user_id: null\n            },\n            attributes: preview.attributes,\n            state: preview.state\n          };\n        };\n      }\n    }, {\n      kind: \"field\",\n      key: \"_debouncedSubscribePreview\",\n      value() {\n        return debounce(() => {\n          this._subscribePreview();\n        }, 250);\n      }\n    }, {\n      kind: \"method\",\n      key: \"_subscribePreview\",\n      value: async function _subscribePreview() {\n        if (this._unsub) {\n          (await this._unsub)();\n          this._unsub = undefined;\n        }\n        if (this.flowType === \"repair_flow\") {\n          return;\n        }\n        try {\n          this._unsub = subscribePreviewTemplate(this.hass, this.flowId, this.flowType, this.stepData, this._setPreview);\n          await this._unsub;\n          fireEvent(this, \"set-flow-errors\", {\n            errors: {}\n          });\n        } catch (err) {\n          if (typeof err.message === \"string\") {\n            this._error = err.message;\n          } else {\n            this._error = undefined;\n            fireEvent(this, \"set-flow-errors\", err.message);\n          }\n          this._unsub = undefined;\n          this._preview = undefined;\n        }\n      }\n    }]\n  };\n}, LitElement);","map":{"version":3,"names":["LitElement","html","nothing","customElement","property","state","debounce","subscribePreviewTemplate","fireEvent","FlowPreviewTemplate","_decorate","_initialize","_LitElement","constructor","args","F","d","kind","decorators","attribute","key","value","disconnectedCallback","_get","_getPrototypeOf","prototype","call","_unsub","then","unsub","undefined","willUpdate","changedProps","has","_debouncedSubscribePreview","render","_this$_listeners","_error","hass","_preview","_listeners","time","localize","all","domains","length","entities","sort","map","domain","entity_id","preview","error","listeners","now","Date","toISOString","stepId","last_changed","last_updated","context","id","parent_id","user_id","attributes","_subscribePreview","flowType","flowId","stepData","_setPreview","errors","err","message"],"sources":["/workspaces/frontend/src/dialogs/config-flow/previews/flow-preview-template.ts"],"sourcesContent":["import { HassEntity, UnsubscribeFunc } from \"home-assistant-js-websocket\";\nimport { LitElement, html, nothing } from \"lit\";\nimport { customElement, property, state } from \"lit/decorators\";\nimport { debounce } from \"../../../common/util/debounce\";\nimport { FlowType } from \"../../../data/data_entry_flow\";\nimport {\n  TemplateListeners,\n  TemplatePreview,\n  subscribePreviewTemplate,\n} from \"../../../data/ws-templates\";\nimport { HomeAssistant } from \"../../../types\";\nimport \"./entity-preview-row\";\nimport { fireEvent } from \"../../../common/dom/fire_event\";\n\n@customElement(\"flow-preview-template\")\nclass FlowPreviewTemplate extends LitElement {\n  @property({ attribute: false }) public hass!: HomeAssistant;\n\n  @property() public flowType!: FlowType;\n\n  public handler!: string;\n\n  @property() public stepId!: string;\n\n  @property() public flowId!: string;\n\n  @property({ attribute: false }) public stepData!: Record<string, any>;\n\n  @state() private _preview?: HassEntity;\n\n  @state() private _listeners?: TemplateListeners;\n\n  @state() private _error?: string;\n\n  private _unsub?: Promise<UnsubscribeFunc>;\n\n  disconnectedCallback(): void {\n    super.disconnectedCallback();\n    if (this._unsub) {\n      this._unsub.then((unsub) => unsub());\n      this._unsub = undefined;\n    }\n  }\n\n  willUpdate(changedProps) {\n    if (changedProps.has(\"stepData\")) {\n      this._debouncedSubscribePreview();\n    }\n  }\n\n  protected render() {\n    if (this._error) {\n      return html`<ha-alert alert-type=\"error\">${this._error}</ha-alert>`;\n    }\n    return html`<entity-preview-row\n        .hass=${this.hass}\n        .stateObj=${this._preview}\n      ></entity-preview-row>\n      ${this._listeners?.time\n        ? html`\n            <p>\n              ${this.hass.localize(\"ui.dialogs.helper_settings.template.time\")}\n            </p>\n          `\n        : nothing}\n      ${!this._listeners\n        ? nothing\n        : this._listeners.all\n          ? html`\n              <p class=\"all_listeners\">\n                ${this.hass.localize(\n                  \"ui.dialogs.helper_settings.template.all_listeners\"\n                )}\n              </p>\n            `\n          : this._listeners.domains.length || this._listeners.entities.length\n            ? html`\n                <p>\n                  ${this.hass.localize(\n                    \"ui.dialogs.helper_settings.template.listeners\"\n                  )}\n                </p>\n                <ul>\n                  ${this._listeners.domains\n                    .sort()\n                    .map(\n                      (domain) => html`\n                        <li>\n                          <b\n                            >${this.hass.localize(\n                              \"ui.dialogs.helper_settings.template.domain\"\n                            )}</b\n                          >: ${domain}\n                        </li>\n                      `\n                    )}\n                  ${this._listeners.entities\n                    .sort()\n                    .map(\n                      (entity_id) => html`\n                        <li>\n                          <b\n                            >${this.hass.localize(\n                              \"ui.dialogs.helper_settings.template.entity\"\n                            )}</b\n                          >: ${entity_id}\n                        </li>\n                      `\n                    )}\n                </ul>\n              `\n            : !this._listeners.time\n              ? html`<p class=\"all_listeners\">\n                  ${this.hass.localize(\n                    \"ui.dialogs.helper_settings.template.no_listeners\"\n                  )}\n                </p>`\n              : nothing} `;\n  }\n\n  private _setPreview = (preview: TemplatePreview) => {\n    if (\"error\" in preview) {\n      this._error = preview.error;\n      this._preview = undefined;\n      return;\n    }\n    this._error = undefined;\n    this._listeners = preview.listeners;\n    const now = new Date().toISOString();\n    this._preview = {\n      entity_id: `${this.stepId}.___flow_preview___`,\n      last_changed: now,\n      last_updated: now,\n      context: { id: \"\", parent_id: null, user_id: null },\n      attributes: preview.attributes,\n      state: preview.state,\n    };\n  };\n\n  private _debouncedSubscribePreview = debounce(() => {\n    this._subscribePreview();\n  }, 250);\n\n  private async _subscribePreview() {\n    if (this._unsub) {\n      (await this._unsub)();\n      this._unsub = undefined;\n    }\n    if (this.flowType === \"repair_flow\") {\n      return;\n    }\n    try {\n      this._unsub = subscribePreviewTemplate(\n        this.hass,\n        this.flowId,\n        this.flowType,\n        this.stepData,\n        this._setPreview\n      );\n      await this._unsub;\n      fireEvent(this, \"set-flow-errors\", { errors: {} });\n    } catch (err: any) {\n      if (typeof err.message === \"string\") {\n        this._error = err.message;\n      } else {\n        this._error = undefined;\n        fireEvent(this, \"set-flow-errors\", err.message);\n      }\n      this._unsub = undefined;\n      this._preview = undefined;\n    }\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"flow-preview-template\": FlowPreviewTemplate;\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}