{"ast":null,"code":"import _decorate from \"@babel/runtime/helpers/decorate\";\nimport _get from \"@babel/runtime/helpers/get\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/getPrototypeOf\";\n/* eslint-disable lit/prefer-static-styles */\nimport \"@material/mwc-button\";\nimport { genClientId } from \"home-assistant-js-websocket\";\nimport { html, LitElement, nothing } from \"lit\";\nimport { customElement, property, state } from \"lit/decorators\";\nimport \"../components/ha-alert\";\nimport \"../components/ha-checkbox\";\nimport { computeInitialHaFormData } from \"../components/ha-form/compute-initial-ha-form-data\";\nimport \"../components/ha-formfield\";\nimport { autocompleteLoginFields, createLoginFlow, deleteLoginFlow, redirectWithAuthCode, submitLoginFlow } from \"../data/auth\";\nimport \"./ha-auth-form\";\nexport let HaAuthFlow = _decorate([customElement(\"ha-auth-flow\")], function (_initialize, _LitElement) {\n  class HaAuthFlow extends _LitElement {\n    constructor(...args) {\n      super(...args);\n      _initialize(this);\n    }\n  }\n  return {\n    F: HaAuthFlow,\n    d: [{\n      kind: \"field\",\n      decorators: [property({\n        attribute: false\n      })],\n      key: \"authProvider\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [property()],\n      key: \"clientId\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [property()],\n      key: \"redirectUri\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [property()],\n      key: \"oauth2State\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [property({\n        attribute: false\n      })],\n      key: \"localize\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [property({\n        attribute: false\n      })],\n      key: \"step\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [property({\n        type: Boolean\n      })],\n      key: \"initStoreToken\",\n      value() {\n        return false;\n      }\n    }, {\n      kind: \"field\",\n      decorators: [state()],\n      key: \"_storeToken\",\n      value() {\n        return false;\n      }\n    }, {\n      kind: \"field\",\n      decorators: [state()],\n      key: \"_state\",\n      value() {\n        return \"loading\";\n      }\n    }, {\n      kind: \"field\",\n      decorators: [state()],\n      key: \"_stepData\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [state()],\n      key: \"_errorMessage\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [state()],\n      key: \"_submitting\",\n      value() {\n        return false;\n      }\n    }, {\n      kind: \"method\",\n      key: \"createRenderRoot\",\n      value: function createRenderRoot() {\n        return this;\n      }\n    }, {\n      kind: \"method\",\n      key: \"willUpdate\",\n      value: function willUpdate(changedProps) {\n        _get(_getPrototypeOf(HaAuthFlow.prototype), \"willUpdate\", this).call(this, changedProps);\n        if (!this.hasUpdated) {\n          this._storeToken = this.initStoreToken;\n        }\n        if (!changedProps.has(\"step\")) {\n          return;\n        }\n        if (!this.step) {\n          this._stepData = undefined;\n          return;\n        }\n        this._state = \"step\";\n        const oldStep = changedProps.get(\"step\");\n        if (!oldStep || this.step.flow_id !== oldStep.flow_id || this.step.type === \"form\" && oldStep.type === \"form\" && this.step.step_id !== oldStep.step_id) {\n          this._stepData = this.step.type === \"form\" ? computeInitialHaFormData(this.step.data_schema) : undefined;\n        }\n      }\n    }, {\n      kind: \"method\",\n      key: \"render\",\n      value: function render() {\n        return html`\n      <style>\n        ha-auth-flow .store-token {\n          margin-left: -16px;\n          margin-inline-start: -16px;\n          margin-inline-end: initial;\n        }\n        a.forgot-password {\n          color: var(--primary-color);\n          text-decoration: none;\n          font-size: 0.875rem;\n        }\n        .space-between {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n        }\n        form {\n          text-align: center;\n          max-width: 336px;\n          width: 100%;\n        }\n        ha-auth-form {\n          display: block;\n          margin-top: 16px;\n        }\n      </style>\n      <form>${this._renderForm()}</form>\n    `;\n      }\n    }, {\n      kind: \"method\",\n      key: \"firstUpdated\",\n      value: function firstUpdated(changedProps) {\n        _get(_getPrototypeOf(HaAuthFlow.prototype), \"firstUpdated\", this).call(this, changedProps);\n        if (this.clientId == null || this.redirectUri == null) {\n          // eslint-disable-next-line no-console\n          console.error(\"clientId and redirectUri must not be null\", this.clientId, this.redirectUri);\n          this._state = \"error\";\n          this._errorMessage = this._unknownError();\n          return;\n        }\n        this.addEventListener(\"keypress\", ev => {\n          if (ev.key === \"Enter\") {\n            this._handleSubmit(ev);\n          }\n        });\n      }\n    }, {\n      kind: \"method\",\n      key: \"updated\",\n      value: function updated(changedProps) {\n        var _this$step;\n        _get(_getPrototypeOf(HaAuthFlow.prototype), \"updated\", this).call(this, changedProps);\n        if (changedProps.has(\"authProvider\")) {\n          this._providerChanged(this.authProvider);\n        }\n        if (!changedProps.has(\"step\") || ((_this$step = this.step) === null || _this$step === void 0 ? void 0 : _this$step.type) !== \"form\") {\n          return;\n        }\n\n        // 100ms to give all the form elements time to initialize.\n        setTimeout(() => {\n          const form = this.renderRoot.querySelector(\"ha-form\");\n          if (form) {\n            form.focus();\n          }\n        }, 100);\n      }\n    }, {\n      kind: \"method\",\n      key: \"_renderForm\",\n      value: function _renderForm() {\n        switch (this._state) {\n          case \"step\":\n            if (this.step == null) {\n              return nothing;\n            }\n            return html`\n          ${this._renderStep(this.step)}\n          <div class=\"action\">\n            <mwc-button\n              raised\n              @click=${this._handleSubmit}\n              .disabled=${this._submitting}\n            >\n              ${this.step.type === \"form\" ? this.localize(\"ui.panel.page-authorize.form.next\") : this.localize(\"ui.panel.page-authorize.form.start_over\")}\n            </mwc-button>\n          </div>\n        `;\n          case \"error\":\n            return html`\n          <ha-alert alert-type=\"error\">\n            ${this.localize(\"ui.panel.page-authorize.form.error\", {\n              error: this._errorMessage\n            })}\n          </ha-alert>\n          <div class=\"action\">\n            <mwc-button raised @click=${this._startOver}>\n              ${this.localize(\"ui.panel.page-authorize.form.start_over\")}\n            </mwc-button>\n          </div>\n        `;\n          case \"loading\":\n            return html`\n          <ha-alert alert-type=\"info\">\n            ${this.localize(\"ui.panel.page-authorize.form.working\")}\n          </ha-alert>\n        `;\n          default:\n            return nothing;\n        }\n      }\n    }, {\n      kind: \"method\",\n      key: \"_renderStep\",\n      value: function _renderStep(step) {\n        switch (step.type) {\n          case \"abort\":\n            return html`\n          ${this.localize(\"ui.panel.page-authorize.abort_intro\")}:\n          ${this.localize(`ui.panel.page-authorize.form.providers.${step.handler[0]}.abort.${step.reason}`)}\n        `;\n          case \"form\":\n            return html`\n          <h1>\n            ${![\"select_mfa_module\", \"mfa\"].includes(step.step_id) ? this.localize(\"ui.panel.page-authorize.welcome_home\") : this.localize(\"ui.panel.page-authorize.just_checking\")}\n          </h1>\n          ${this._computeStepDescription(step)}\n          <ha-auth-form\n            .localize=${this.localize}\n            .data=${this._stepData}\n            .schema=${autocompleteLoginFields(step.data_schema)}\n            .error=${step.errors}\n            .disabled=${this._submitting}\n            .computeLabel=${this._computeLabelCallback(step)}\n            .computeError=${this._computeErrorCallback(step)}\n            @value-changed=${this._stepDataChanged}\n          ></ha-auth-form>\n          ${this.clientId === genClientId() && ![\"select_mfa_module\", \"mfa\"].includes(step.step_id) ? html`\n                <div class=\"space-between\">\n                  <ha-formfield\n                    class=\"store-token\"\n                    .label=${this.localize(\"ui.panel.page-authorize.store_token\")}\n                  >\n                    <ha-checkbox\n                      .checked=${this._storeToken}\n                      @change=${this._storeTokenChanged}\n                    ></ha-checkbox>\n                  </ha-formfield>\n                  <a\n                    class=\"forgot-password\"\n                    href=\"https://www.home-assistant.io/docs/locked_out/#forgot-password\"\n                    target=\"_blank\"\n                    rel=\"noreferrer noopener\"\n                    >${this.localize(\"ui.panel.page-authorize.forgot_password\")}</a\n                  >\n                </div>\n              ` : \"\"}\n        `;\n          default:\n            return nothing;\n        }\n      }\n    }, {\n      kind: \"method\",\n      key: \"_storeTokenChanged\",\n      value: function _storeTokenChanged(e) {\n        this._storeToken = e.currentTarget.checked;\n      }\n    }, {\n      kind: \"method\",\n      key: \"_providerChanged\",\n      value: async function _providerChanged(newProvider) {\n        if (this.step && this.step.type === \"form\") {\n          deleteLoginFlow(this.step.flow_id).catch(err => {\n            // eslint-disable-next-line no-console\n            console.error(\"Error delete obsoleted auth flow\", err);\n          });\n        }\n        if (newProvider == null) {\n          // eslint-disable-next-line no-console\n          console.error(\"No auth provider\");\n          this._state = \"error\";\n          this._errorMessage = this._unknownError();\n          return;\n        }\n        try {\n          const response = await createLoginFlow(this.clientId, this.redirectUri, [newProvider.type, newProvider.id]);\n          const data = await response.json();\n          if (response.ok) {\n            // allow auth provider bypass the login form\n            if (data.type === \"create_entry\") {\n              redirectWithAuthCode(this.redirectUri, data.result, this.oauth2State, this._storeToken);\n              return;\n            }\n            this.step = data;\n            this._state = \"step\";\n          } else {\n            this._state = \"error\";\n            this._errorMessage = data.message;\n          }\n        } catch (err) {\n          // eslint-disable-next-line no-console\n          console.error(\"Error starting auth flow\", err);\n          this._state = \"error\";\n          this._errorMessage = this._unknownError();\n        }\n      }\n    }, {\n      kind: \"method\",\n      key: \"_stepDataChanged\",\n      value: function _stepDataChanged(ev) {\n        this._stepData = ev.detail.value;\n      }\n    }, {\n      kind: \"method\",\n      key: \"_computeStepDescription\",\n      value: function _computeStepDescription(step) {\n        const resourceKey = `ui.panel.page-authorize.form.providers.${step.handler[0]}.step.${step.step_id}.description`;\n        return this.localize(resourceKey, step.description_placeholders);\n      }\n    }, {\n      kind: \"method\",\n      key: \"_computeLabelCallback\",\n      value: function _computeLabelCallback(step) {\n        // Returns a callback for ha-form to calculate labels per schema object\n        return schema => this.localize(`ui.panel.page-authorize.form.providers.${step.handler[0]}.step.${step.step_id}.data.${schema.name}`);\n      }\n    }, {\n      kind: \"method\",\n      key: \"_computeErrorCallback\",\n      value: function _computeErrorCallback(step) {\n        // Returns a callback for ha-form to calculate error messages\n        return error => this.localize(`ui.panel.page-authorize.form.providers.${step.handler[0]}.error.${error}`);\n      }\n    }, {\n      kind: \"method\",\n      key: \"_unknownError\",\n      value: function _unknownError() {\n        return this.localize(\"ui.panel.page-authorize.form.unknown_error\");\n      }\n    }, {\n      kind: \"method\",\n      key: \"_startOver\",\n      value: function _startOver() {\n        this._providerChanged(this.authProvider);\n      }\n    }, {\n      kind: \"method\",\n      key: \"_handleSubmit\",\n      value: async function _handleSubmit(ev) {\n        ev.preventDefault();\n        if (this.step == null) {\n          return;\n        }\n        if (this.step.type !== \"form\") {\n          this._providerChanged(this.authProvider);\n          return;\n        }\n        this._submitting = true;\n        const postData = {\n          ...this._stepData,\n          client_id: this.clientId\n        };\n        try {\n          const response = await submitLoginFlow(this.step.flow_id, postData);\n          const newStep = await response.json();\n          if (response.status === 403) {\n            this._state = \"error\";\n            this._errorMessage = newStep.message;\n            return;\n          }\n          if (newStep.type === \"create_entry\") {\n            redirectWithAuthCode(this.redirectUri, newStep.result, this.oauth2State, this._storeToken);\n            return;\n          }\n          this.step = newStep;\n          this._state = \"step\";\n        } catch (err) {\n          // eslint-disable-next-line no-console\n          console.error(\"Error submitting step\", err);\n          this._state = \"error\";\n          this._errorMessage = this._unknownError();\n        } finally {\n          this._submitting = false;\n        }\n      }\n    }]\n  };\n}, LitElement);","map":{"version":3,"names":["genClientId","html","LitElement","nothing","customElement","property","state","computeInitialHaFormData","autocompleteLoginFields","createLoginFlow","deleteLoginFlow","redirectWithAuthCode","submitLoginFlow","HaAuthFlow","_decorate","_initialize","_LitElement","constructor","args","F","d","kind","decorators","attribute","key","value","type","Boolean","createRenderRoot","willUpdate","changedProps","_get","_getPrototypeOf","prototype","call","hasUpdated","_storeToken","initStoreToken","has","step","_stepData","undefined","_state","oldStep","get","flow_id","step_id","data_schema","render","_renderForm","firstUpdated","clientId","redirectUri","console","error","_errorMessage","_unknownError","addEventListener","ev","_handleSubmit","updated","_this$step","_providerChanged","authProvider","setTimeout","form","renderRoot","querySelector","focus","_renderStep","_submitting","localize","_startOver","handler","reason","includes","_computeStepDescription","errors","_computeLabelCallback","_computeErrorCallback","_stepDataChanged","_storeTokenChanged","e","currentTarget","checked","newProvider","catch","err","response","id","data","json","ok","result","oauth2State","message","detail","resourceKey","description_placeholders","schema","name","preventDefault","postData","client_id","newStep","status"],"sources":["/workspaces/frontend/src/auth/ha-auth-flow.ts"],"sourcesContent":["/* eslint-disable lit/prefer-static-styles */\nimport \"@material/mwc-button\";\nimport { genClientId } from \"home-assistant-js-websocket\";\nimport { html, LitElement, nothing, PropertyValues } from \"lit\";\nimport { customElement, property, state } from \"lit/decorators\";\nimport { LocalizeFunc } from \"../common/translations/localize\";\nimport \"../components/ha-alert\";\nimport \"../components/ha-checkbox\";\nimport { computeInitialHaFormData } from \"../components/ha-form/compute-initial-ha-form-data\";\nimport \"../components/ha-formfield\";\nimport {\n  AuthProvider,\n  autocompleteLoginFields,\n  createLoginFlow,\n  deleteLoginFlow,\n  redirectWithAuthCode,\n  submitLoginFlow,\n} from \"../data/auth\";\nimport {\n  DataEntryFlowStep,\n  DataEntryFlowStepForm,\n} from \"../data/data_entry_flow\";\nimport \"./ha-auth-form\";\n\ntype State = \"loading\" | \"error\" | \"step\";\n\n@customElement(\"ha-auth-flow\")\nexport class HaAuthFlow extends LitElement {\n  @property({ attribute: false }) public authProvider?: AuthProvider;\n\n  @property() public clientId?: string;\n\n  @property() public redirectUri?: string;\n\n  @property() public oauth2State?: string;\n\n  @property({ attribute: false }) public localize!: LocalizeFunc;\n\n  @property({ attribute: false }) public step?: DataEntryFlowStep;\n\n  @property({ type: Boolean }) public initStoreToken = false;\n\n  @state() private _storeToken = false;\n\n  @state() private _state: State = \"loading\";\n\n  @state() private _stepData?: Record<string, any>;\n\n  @state() private _errorMessage?: string;\n\n  @state() private _submitting = false;\n\n  createRenderRoot() {\n    return this;\n  }\n\n  willUpdate(changedProps: PropertyValues) {\n    super.willUpdate(changedProps);\n\n    if (!this.hasUpdated) {\n      this._storeToken = this.initStoreToken;\n    }\n\n    if (!changedProps.has(\"step\")) {\n      return;\n    }\n\n    if (!this.step) {\n      this._stepData = undefined;\n      return;\n    }\n\n    this._state = \"step\";\n\n    const oldStep = changedProps.get(\"step\") as HaAuthFlow[\"step\"];\n\n    if (\n      !oldStep ||\n      this.step.flow_id !== oldStep.flow_id ||\n      (this.step.type === \"form\" &&\n        oldStep.type === \"form\" &&\n        this.step.step_id !== oldStep.step_id)\n    ) {\n      this._stepData =\n        this.step.type === \"form\"\n          ? computeInitialHaFormData(this.step.data_schema)\n          : undefined;\n    }\n  }\n\n  protected render() {\n    return html`\n      <style>\n        ha-auth-flow .store-token {\n          margin-left: -16px;\n          margin-inline-start: -16px;\n          margin-inline-end: initial;\n        }\n        a.forgot-password {\n          color: var(--primary-color);\n          text-decoration: none;\n          font-size: 0.875rem;\n        }\n        .space-between {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n        }\n        form {\n          text-align: center;\n          max-width: 336px;\n          width: 100%;\n        }\n        ha-auth-form {\n          display: block;\n          margin-top: 16px;\n        }\n      </style>\n      <form>${this._renderForm()}</form>\n    `;\n  }\n\n  protected firstUpdated(changedProps: PropertyValues) {\n    super.firstUpdated(changedProps);\n\n    if (this.clientId == null || this.redirectUri == null) {\n      // eslint-disable-next-line no-console\n      console.error(\n        \"clientId and redirectUri must not be null\",\n        this.clientId,\n        this.redirectUri\n      );\n      this._state = \"error\";\n      this._errorMessage = this._unknownError();\n      return;\n    }\n\n    this.addEventListener(\"keypress\", (ev) => {\n      if (ev.key === \"Enter\") {\n        this._handleSubmit(ev);\n      }\n    });\n  }\n\n  protected updated(changedProps: PropertyValues): void {\n    super.updated(changedProps);\n    if (changedProps.has(\"authProvider\")) {\n      this._providerChanged(this.authProvider);\n    }\n\n    if (!changedProps.has(\"step\") || this.step?.type !== \"form\") {\n      return;\n    }\n\n    // 100ms to give all the form elements time to initialize.\n    setTimeout(() => {\n      const form = this.renderRoot.querySelector(\"ha-form\");\n      if (form) {\n        (form as any).focus();\n      }\n    }, 100);\n  }\n\n  private _renderForm() {\n    switch (this._state) {\n      case \"step\":\n        if (this.step == null) {\n          return nothing;\n        }\n\n        return html`\n          ${this._renderStep(this.step)}\n          <div class=\"action\">\n            <mwc-button\n              raised\n              @click=${this._handleSubmit}\n              .disabled=${this._submitting}\n            >\n              ${this.step.type === \"form\"\n                ? this.localize(\"ui.panel.page-authorize.form.next\")\n                : this.localize(\"ui.panel.page-authorize.form.start_over\")}\n            </mwc-button>\n          </div>\n        `;\n      case \"error\":\n        return html`\n          <ha-alert alert-type=\"error\">\n            ${this.localize(\"ui.panel.page-authorize.form.error\", {\n              error: this._errorMessage,\n            })}\n          </ha-alert>\n          <div class=\"action\">\n            <mwc-button raised @click=${this._startOver}>\n              ${this.localize(\"ui.panel.page-authorize.form.start_over\")}\n            </mwc-button>\n          </div>\n        `;\n      case \"loading\":\n        return html`\n          <ha-alert alert-type=\"info\">\n            ${this.localize(\"ui.panel.page-authorize.form.working\")}\n          </ha-alert>\n        `;\n      default:\n        return nothing;\n    }\n  }\n\n  private _renderStep(step: DataEntryFlowStep) {\n    switch (step.type) {\n      case \"abort\":\n        return html`\n          ${this.localize(\"ui.panel.page-authorize.abort_intro\")}:\n          ${this.localize(\n            `ui.panel.page-authorize.form.providers.${step.handler[0]}.abort.${step.reason}`\n          )}\n        `;\n      case \"form\":\n        return html`\n          <h1>\n            ${![\"select_mfa_module\", \"mfa\"].includes(step.step_id)\n              ? this.localize(\"ui.panel.page-authorize.welcome_home\")\n              : this.localize(\"ui.panel.page-authorize.just_checking\")}\n          </h1>\n          ${this._computeStepDescription(step)}\n          <ha-auth-form\n            .localize=${this.localize}\n            .data=${this._stepData!}\n            .schema=${autocompleteLoginFields(step.data_schema)}\n            .error=${step.errors}\n            .disabled=${this._submitting}\n            .computeLabel=${this._computeLabelCallback(step)}\n            .computeError=${this._computeErrorCallback(step)}\n            @value-changed=${this._stepDataChanged}\n          ></ha-auth-form>\n          ${this.clientId === genClientId() &&\n          ![\"select_mfa_module\", \"mfa\"].includes(step.step_id)\n            ? html`\n                <div class=\"space-between\">\n                  <ha-formfield\n                    class=\"store-token\"\n                    .label=${this.localize(\n                      \"ui.panel.page-authorize.store_token\"\n                    )}\n                  >\n                    <ha-checkbox\n                      .checked=${this._storeToken}\n                      @change=${this._storeTokenChanged}\n                    ></ha-checkbox>\n                  </ha-formfield>\n                  <a\n                    class=\"forgot-password\"\n                    href=\"https://www.home-assistant.io/docs/locked_out/#forgot-password\"\n                    target=\"_blank\"\n                    rel=\"noreferrer noopener\"\n                    >${this.localize(\n                      \"ui.panel.page-authorize.forgot_password\"\n                    )}</a\n                  >\n                </div>\n              `\n            : \"\"}\n        `;\n      default:\n        return nothing;\n    }\n  }\n\n  private _storeTokenChanged(e: CustomEvent<HTMLInputElement>) {\n    this._storeToken = (e.currentTarget as HTMLInputElement).checked;\n  }\n\n  private async _providerChanged(newProvider?: AuthProvider) {\n    if (this.step && this.step.type === \"form\") {\n      deleteLoginFlow(this.step.flow_id).catch((err) => {\n        // eslint-disable-next-line no-console\n        console.error(\"Error delete obsoleted auth flow\", err);\n      });\n    }\n\n    if (newProvider == null) {\n      // eslint-disable-next-line no-console\n      console.error(\"No auth provider\");\n      this._state = \"error\";\n      this._errorMessage = this._unknownError();\n      return;\n    }\n\n    try {\n      const response = await createLoginFlow(this.clientId, this.redirectUri, [\n        newProvider.type,\n        newProvider.id,\n      ]);\n\n      const data = await response.json();\n\n      if (response.ok) {\n        // allow auth provider bypass the login form\n        if (data.type === \"create_entry\") {\n          redirectWithAuthCode(\n            this.redirectUri!,\n            data.result,\n            this.oauth2State,\n            this._storeToken\n          );\n          return;\n        }\n\n        this.step = data;\n        this._state = \"step\";\n      } else {\n        this._state = \"error\";\n        this._errorMessage = data.message;\n      }\n    } catch (err: any) {\n      // eslint-disable-next-line no-console\n      console.error(\"Error starting auth flow\", err);\n      this._state = \"error\";\n      this._errorMessage = this._unknownError();\n    }\n  }\n\n  private _stepDataChanged(ev: CustomEvent) {\n    this._stepData = ev.detail.value;\n  }\n\n  private _computeStepDescription(step: DataEntryFlowStepForm) {\n    const resourceKey =\n      `ui.panel.page-authorize.form.providers.${step.handler[0]}.step.${step.step_id}.description` as const;\n    return this.localize(resourceKey, step.description_placeholders);\n  }\n\n  private _computeLabelCallback(step: DataEntryFlowStepForm) {\n    // Returns a callback for ha-form to calculate labels per schema object\n    return (schema) =>\n      this.localize(\n        `ui.panel.page-authorize.form.providers.${step.handler[0]}.step.${step.step_id}.data.${schema.name}`\n      );\n  }\n\n  private _computeErrorCallback(step: DataEntryFlowStepForm) {\n    // Returns a callback for ha-form to calculate error messages\n    return (error) =>\n      this.localize(\n        `ui.panel.page-authorize.form.providers.${step.handler[0]}.error.${error}`\n      );\n  }\n\n  private _unknownError() {\n    return this.localize(\"ui.panel.page-authorize.form.unknown_error\");\n  }\n\n  private _startOver() {\n    this._providerChanged(this.authProvider);\n  }\n\n  private async _handleSubmit(ev: Event) {\n    ev.preventDefault();\n    if (this.step == null) {\n      return;\n    }\n    if (this.step.type !== \"form\") {\n      this._providerChanged(this.authProvider);\n      return;\n    }\n    this._submitting = true;\n\n    const postData = { ...this._stepData, client_id: this.clientId };\n\n    try {\n      const response = await submitLoginFlow(this.step.flow_id, postData);\n\n      const newStep = await response.json();\n\n      if (response.status === 403) {\n        this._state = \"error\";\n        this._errorMessage = newStep.message;\n        return;\n      }\n\n      if (newStep.type === \"create_entry\") {\n        redirectWithAuthCode(\n          this.redirectUri!,\n          newStep.result,\n          this.oauth2State,\n          this._storeToken\n        );\n        return;\n      }\n      this.step = newStep;\n      this._state = \"step\";\n    } catch (err: any) {\n      // eslint-disable-next-line no-console\n      console.error(\"Error submitting step\", err);\n      this._state = \"error\";\n      this._errorMessage = this._unknownError();\n    } finally {\n      this._submitting = false;\n    }\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"ha-auth-flow\": HaAuthFlow;\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}