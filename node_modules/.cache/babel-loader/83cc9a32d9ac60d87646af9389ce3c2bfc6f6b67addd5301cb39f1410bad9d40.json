{"ast":null,"code":"/**\n * @license\n * Copyright 2021 Google LLC\n * SPDX-License-Identifier: BSD-3-Clause\n */\nimport { html, noChange } from 'lit';\nimport { directive, PartType } from 'lit/directive.js';\nimport { AsyncDirective } from 'lit/async-directive.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { Virtualizer } from './Virtualizer.js';\nexport { virtualizerRef } from './Virtualizer.js';\nexport const defaultKeyFunction = item => item;\nexport const defaultRenderItem = (item, idx) => html`${idx}: ${JSON.stringify(item, null, 2)}`;\nclass VirtualizeDirective extends AsyncDirective {\n  constructor(part) {\n    super(part);\n    this._virtualizer = null;\n    this._first = 0;\n    this._last = -1;\n    this._renderItem = (item, idx) => defaultRenderItem(item, idx + this._first);\n    this._keyFunction = (item, idx) => defaultKeyFunction(item, idx + this._first);\n    this._items = [];\n    if (part.type !== PartType.CHILD) {\n      throw new Error('The virtualize directive can only be used in child expressions');\n    }\n  }\n  render(config) {\n    if (config) {\n      this._setFunctions(config);\n    }\n    const itemsToRender = [];\n    if (this._first >= 0 && this._last >= this._first) {\n      for (let i = this._first; i <= this._last; i++) {\n        itemsToRender.push(this._items[i]);\n      }\n    }\n    return repeat(itemsToRender, this._keyFunction, this._renderItem);\n  }\n  update(part, [config]) {\n    this._setFunctions(config);\n    const itemsChanged = this._items !== config.items;\n    this._items = config.items || [];\n    if (this._virtualizer) {\n      this._updateVirtualizerConfig(part, config);\n    } else {\n      this._initialize(part, config);\n    }\n    return itemsChanged ? noChange : this.render();\n  }\n  async _updateVirtualizerConfig(part, config) {\n    const compatible = await this._virtualizer.updateLayoutConfig(config.layout || {});\n    if (!compatible) {\n      const hostElement = part.parentNode;\n      this._makeVirtualizer(hostElement, config);\n    }\n    this._virtualizer.items = this._items;\n  }\n  _setFunctions(config) {\n    const {\n      renderItem,\n      keyFunction\n    } = config;\n    if (renderItem) {\n      this._renderItem = (item, idx) => renderItem(item, idx + this._first);\n    }\n    if (keyFunction) {\n      this._keyFunction = (item, idx) => keyFunction(item, idx + this._first);\n    }\n  }\n  _makeVirtualizer(hostElement, config) {\n    if (this._virtualizer) {\n      this._virtualizer.disconnected();\n    }\n    const {\n      layout,\n      scroller,\n      items\n    } = config;\n    this._virtualizer = new Virtualizer({\n      hostElement,\n      layout,\n      scroller\n    });\n    this._virtualizer.items = items;\n    this._virtualizer.connected();\n  }\n  _initialize(part, config) {\n    const hostElement = part.parentNode;\n    if (hostElement && hostElement.nodeType === 1) {\n      hostElement.addEventListener('rangeChanged', e => {\n        this._first = e.first;\n        this._last = e.last;\n        this.setValue(this.render());\n      });\n      this._makeVirtualizer(hostElement, config);\n    }\n  }\n  disconnected() {\n    var _this$_virtualizer;\n    (_this$_virtualizer = this._virtualizer) === null || _this$_virtualizer === void 0 || _this$_virtualizer.disconnected();\n  }\n  reconnected() {\n    var _this$_virtualizer2;\n    (_this$_virtualizer2 = this._virtualizer) === null || _this$_virtualizer2 === void 0 || _this$_virtualizer2.connected();\n  }\n}\nexport const virtualize = directive(VirtualizeDirective);","map":{"version":3,"names":["html","noChange","directive","PartType","AsyncDirective","repeat","Virtualizer","virtualizerRef","defaultKeyFunction","item","defaultRenderItem","idx","JSON","stringify","VirtualizeDirective","constructor","part","_virtualizer","_first","_last","_renderItem","_keyFunction","_items","type","CHILD","Error","render","config","_setFunctions","itemsToRender","i","push","update","itemsChanged","items","_updateVirtualizerConfig","_initialize","compatible","updateLayoutConfig","layout","hostElement","parentNode","_makeVirtualizer","renderItem","keyFunction","disconnected","scroller","connected","nodeType","addEventListener","e","first","last","setValue","_this$_virtualizer","reconnected","_this$_virtualizer2","virtualize"],"sources":["src/virtualize.ts"],"sourcesContent":["/**\n * @license\n * Copyright 2021 Google LLC\n * SPDX-License-Identifier: BSD-3-Clause\n */\n\nimport {TemplateResult, ChildPart, html, noChange} from 'lit';\nimport {directive, DirectiveResult, PartInfo, PartType} from 'lit/directive.js';\nimport {AsyncDirective} from 'lit/async-directive.js';\nimport {repeat, KeyFn} from 'lit/directives/repeat.js';\nimport {Virtualizer} from './Virtualizer.js';\nimport {RangeChangedEvent} from './events.js';\nimport {LayoutConfigValue} from './layouts/shared/Layout.js';\n\nexport {virtualizerRef, VirtualizerHostElement} from './Virtualizer.js';\n\n/**\n * Configuration options for the virtualize directive.\n */\nexport interface VirtualizeDirectiveConfig<T> {\n  /**\n   * A function that returns a lit-html TemplateResult. It will be used\n   * to generate the DOM for each item in the virtual list.\n   */\n  renderItem?: RenderItemFunction<T>;\n\n  keyFunction?: KeyFn<T>;\n\n  scroller?: boolean;\n\n  // TODO (graynorton): Document...\n  layout?: LayoutConfigValue;\n\n  /**\n   * The list of items to display via the renderItem function.\n   */\n  items?: Array<T>;\n}\n\nexport type RenderItemFunction<T = unknown> = (\n  item: T,\n  index: number\n) => TemplateResult;\n\nexport const defaultKeyFunction: KeyFn<unknown> = (item: unknown) => item;\nexport const defaultRenderItem: RenderItemFunction<unknown> = (\n  item: unknown,\n  idx: number\n) => html`${idx}: ${JSON.stringify(item, null, 2)}`;\n\nclass VirtualizeDirective<T = unknown> extends AsyncDirective {\n  _virtualizer: Virtualizer | null = null;\n  _first = 0;\n  _last = -1;\n  _renderItem: RenderItemFunction<T> = (item: T, idx: number) =>\n    defaultRenderItem(item, idx + this._first);\n  _keyFunction: KeyFn<T> = (item: T, idx: number) =>\n    defaultKeyFunction(item, idx + this._first);\n  _items: Array<T> = [];\n\n  constructor(part: PartInfo) {\n    super(part);\n    if (part.type !== PartType.CHILD) {\n      throw new Error(\n        'The virtualize directive can only be used in child expressions'\n      );\n    }\n  }\n\n  render(config?: VirtualizeDirectiveConfig<T>) {\n    if (config) {\n      this._setFunctions(config);\n    }\n    const itemsToRender: Array<T> = [];\n\n    if (this._first >= 0 && this._last >= this._first) {\n      for (let i = this._first; i <= this._last; i++) {\n        itemsToRender.push(this._items[i]);\n      }\n    }\n    return repeat(itemsToRender, this._keyFunction, this._renderItem);\n  }\n\n  update(part: ChildPart, [config]: [VirtualizeDirectiveConfig<T>]) {\n    this._setFunctions(config);\n    const itemsChanged = this._items !== config.items;\n    this._items = config.items || [];\n    if (this._virtualizer) {\n      this._updateVirtualizerConfig(part, config);\n    } else {\n      this._initialize(part, config);\n    }\n    return itemsChanged ? noChange : this.render();\n  }\n\n  private async _updateVirtualizerConfig(\n    part: ChildPart,\n    config: VirtualizeDirectiveConfig<T>\n  ) {\n    const compatible = await this._virtualizer!.updateLayoutConfig(\n      config.layout || {}\n    );\n    if (!compatible) {\n      const hostElement = part.parentNode as HTMLElement;\n      this._makeVirtualizer(hostElement, config);\n    }\n    this._virtualizer!.items = this._items;\n  }\n\n  private _setFunctions(config: VirtualizeDirectiveConfig<T>) {\n    const {renderItem, keyFunction} = config;\n    if (renderItem) {\n      this._renderItem = (item, idx) => renderItem(item, idx + this._first);\n    }\n    if (keyFunction) {\n      this._keyFunction = (item, idx) => keyFunction(item, idx + this._first);\n    }\n  }\n\n  private _makeVirtualizer(\n    hostElement: HTMLElement,\n    config: VirtualizeDirectiveConfig<T>\n  ) {\n    if (this._virtualizer) {\n      this._virtualizer.disconnected();\n    }\n    const {layout, scroller, items} = config;\n    this._virtualizer = new Virtualizer({hostElement, layout, scroller});\n    this._virtualizer.items = items;\n    this._virtualizer.connected();\n  }\n\n  private _initialize(part: ChildPart, config: VirtualizeDirectiveConfig<T>) {\n    const hostElement = part.parentNode as HTMLElement;\n    if (hostElement && hostElement.nodeType === 1) {\n      hostElement.addEventListener('rangeChanged', (e: RangeChangedEvent) => {\n        this._first = e.first;\n        this._last = e.last;\n        this.setValue(this.render());\n      });\n      this._makeVirtualizer(hostElement, config);\n    }\n  }\n\n  disconnected() {\n    this._virtualizer?.disconnected();\n  }\n\n  reconnected() {\n    this._virtualizer?.connected();\n  }\n}\n\nexport const virtualize = directive(VirtualizeDirective) as <T>(\n  config?: VirtualizeDirectiveConfig<T>\n) => DirectiveResult<typeof VirtualizeDirective>;\n"],"mappings":"AAAA;;;;;AAMA,SAAmCA,IAAI,EAAEC,QAAQ,QAAO,KAAK;AAC7D,SAAQC,SAAS,EAA6BC,QAAQ,QAAO,kBAAkB;AAC/E,SAAQC,cAAc,QAAO,wBAAwB;AACrD,SAAQC,MAAM,QAAc,0BAA0B;AACtD,SAAQC,WAAW,QAAO,kBAAkB;AAI5C,SAAQC,cAAc,QAA+B,kBAAkB;AA8BvE,OAAO,MAAMC,kBAAkB,GAAoBC,IAAa,IAAKA,IAAI;AACzE,OAAO,MAAMC,iBAAiB,GAAgCA,CAC5DD,IAAa,EACbE,GAAW,KACRX,IAAI,GAAGW,GAAG,KAAKC,IAAI,CAACC,SAAS,CAACJ,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC,EAAE;AAEnD,MAAMK,mBAAiC,SAAQV,cAAc;EAU3DW,YAAYC,IAAc;IACxB,KAAK,CAACA,IAAI,CAAC;IAVb,KAAAC,YAAY,GAAuB,IAAI;IACvC,KAAAC,MAAM,GAAG,CAAC;IACV,KAAAC,KAAK,GAAG,CAAC,CAAC;IACV,KAAAC,WAAW,GAA0B,CAACX,IAAO,EAAEE,GAAW,KACxDD,iBAAiB,CAACD,IAAI,EAAEE,GAAG,GAAG,IAAI,CAACO,MAAM,CAAC;IAC5C,KAAAG,YAAY,GAAa,CAACZ,IAAO,EAAEE,GAAW,KAC5CH,kBAAkB,CAACC,IAAI,EAAEE,GAAG,GAAG,IAAI,CAACO,MAAM,CAAC;IAC7C,KAAAI,MAAM,GAAa,EAAE;IAInB,IAAIN,IAAI,CAACO,IAAI,KAAKpB,QAAQ,CAACqB,KAAK,EAAE;MAChC,MAAM,IAAIC,KAAK,CACb,gEAAgE,CACjE;;EAEL;EAEAC,MAAMA,CAACC,MAAqC;IAC1C,IAAIA,MAAM,EAAE;MACV,IAAI,CAACC,aAAa,CAACD,MAAM,CAAC;;IAE5B,MAAME,aAAa,GAAa,EAAE;IAElC,IAAI,IAAI,CAACX,MAAM,IAAI,CAAC,IAAI,IAAI,CAACC,KAAK,IAAI,IAAI,CAACD,MAAM,EAAE;MACjD,KAAK,IAAIY,CAAC,GAAG,IAAI,CAACZ,MAAM,EAAEY,CAAC,IAAI,IAAI,CAACX,KAAK,EAAEW,CAAC,EAAE,EAAE;QAC9CD,aAAa,CAACE,IAAI,CAAC,IAAI,CAACT,MAAM,CAACQ,CAAC,CAAC,CAAC;;;IAGtC,OAAOzB,MAAM,CAACwB,aAAa,EAAE,IAAI,CAACR,YAAY,EAAE,IAAI,CAACD,WAAW,CAAC;EACnE;EAEAY,MAAMA,CAAChB,IAAe,EAAE,CAACW,MAAM,CAAiC;IAC9D,IAAI,CAACC,aAAa,CAACD,MAAM,CAAC;IAC1B,MAAMM,YAAY,GAAG,IAAI,CAACX,MAAM,KAAKK,MAAM,CAACO,KAAK;IACjD,IAAI,CAACZ,MAAM,GAAGK,MAAM,CAACO,KAAK,IAAI,EAAE;IAChC,IAAI,IAAI,CAACjB,YAAY,EAAE;MACrB,IAAI,CAACkB,wBAAwB,CAACnB,IAAI,EAAEW,MAAM,CAAC;KAC5C,MAAM;MACL,IAAI,CAACS,WAAW,CAACpB,IAAI,EAAEW,MAAM,CAAC;;IAEhC,OAAOM,YAAY,GAAGhC,QAAQ,GAAG,IAAI,CAACyB,MAAM,EAAE;EAChD;EAEQ,MAAMS,wBAAwBA,CACpCnB,IAAe,EACfW,MAAoC;IAEpC,MAAMU,UAAU,GAAG,MAAM,IAAI,CAACpB,YAAa,CAACqB,kBAAkB,CAC5DX,MAAM,CAACY,MAAM,IAAI,EAAE,CACpB;IACD,IAAI,CAACF,UAAU,EAAE;MACf,MAAMG,WAAW,GAAGxB,IAAI,CAACyB,UAAyB;MAClD,IAAI,CAACC,gBAAgB,CAACF,WAAW,EAAEb,MAAM,CAAC;;IAE5C,IAAI,CAACV,YAAa,CAACiB,KAAK,GAAG,IAAI,CAACZ,MAAM;EACxC;EAEQM,aAAaA,CAACD,MAAoC;IACxD,MAAM;MAACgB,UAAU;MAAEC;IAAW,CAAC,GAAGjB,MAAM;IACxC,IAAIgB,UAAU,EAAE;MACd,IAAI,CAACvB,WAAW,GAAG,CAACX,IAAI,EAAEE,GAAG,KAAKgC,UAAU,CAAClC,IAAI,EAAEE,GAAG,GAAG,IAAI,CAACO,MAAM,CAAC;;IAEvE,IAAI0B,WAAW,EAAE;MACf,IAAI,CAACvB,YAAY,GAAG,CAACZ,IAAI,EAAEE,GAAG,KAAKiC,WAAW,CAACnC,IAAI,EAAEE,GAAG,GAAG,IAAI,CAACO,MAAM,CAAC;;EAE3E;EAEQwB,gBAAgBA,CACtBF,WAAwB,EACxBb,MAAoC;IAEpC,IAAI,IAAI,CAACV,YAAY,EAAE;MACrB,IAAI,CAACA,YAAY,CAAC4B,YAAY,EAAE;;IAElC,MAAM;MAACN,MAAM;MAAEO,QAAQ;MAAEZ;IAAK,CAAC,GAAGP,MAAM;IACxC,IAAI,CAACV,YAAY,GAAG,IAAIX,WAAW,CAAC;MAACkC,WAAW;MAAED,MAAM;MAAEO;IAAQ,CAAC,CAAC;IACpE,IAAI,CAAC7B,YAAY,CAACiB,KAAK,GAAGA,KAAK;IAC/B,IAAI,CAACjB,YAAY,CAAC8B,SAAS,EAAE;EAC/B;EAEQX,WAAWA,CAACpB,IAAe,EAAEW,MAAoC;IACvE,MAAMa,WAAW,GAAGxB,IAAI,CAACyB,UAAyB;IAClD,IAAID,WAAW,IAAIA,WAAW,CAACQ,QAAQ,KAAK,CAAC,EAAE;MAC7CR,WAAW,CAACS,gBAAgB,CAAC,cAAc,EAAGC,CAAoB,IAAI;QACpE,IAAI,CAAChC,MAAM,GAAGgC,CAAC,CAACC,KAAK;QACrB,IAAI,CAAChC,KAAK,GAAG+B,CAAC,CAACE,IAAI;QACnB,IAAI,CAACC,QAAQ,CAAC,IAAI,CAAC3B,MAAM,EAAE,CAAC;MAC9B,CAAC,CAAC;MACF,IAAI,CAACgB,gBAAgB,CAACF,WAAW,EAAEb,MAAM,CAAC;;EAE9C;EAEAkB,YAAYA,CAAA;IAAA,IAAAS,kBAAA;IACV,CAAAA,kBAAA,OAAI,CAACrC,YAAY,cAAAqC,kBAAA,eAAjBA,kBAAA,CAAmBT,YAAY,EAAE;EACnC;EAEAU,WAAWA,CAAA;IAAA,IAAAC,mBAAA;IACT,CAAAA,mBAAA,OAAI,CAACvC,YAAY,cAAAuC,mBAAA,eAAjBA,mBAAA,CAAmBT,SAAS,EAAE;EAChC;;AAGF,OAAO,MAAMU,UAAU,GAAGvD,SAAS,CAACY,mBAAmB,CAEP"},"metadata":{},"sourceType":"module","externalDependencies":[]}