{"ast":null,"code":"import _createForOfIteratorHelper from \"@babel/runtime/helpers/createForOfIteratorHelper\";\nimport _toConsumableArray from \"@babel/runtime/helpers/toConsumableArray\";\nimport _taggedTemplateLiteral from \"@babel/runtime/helpers/taggedTemplateLiteral\";\nimport _regeneratorRuntime from \"@babel/runtime/helpers/regeneratorRuntime\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/asyncToGenerator\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\nimport _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _callSuper from \"@babel/runtime/helpers/callSuper\";\nimport _assertThisInitialized from \"@babel/runtime/helpers/assertThisInitialized\";\nimport _inherits from \"@babel/runtime/helpers/inherits\";\nimport _decorate from \"@babel/runtime/helpers/decorate\";\nimport _get from \"@babel/runtime/helpers/get\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/getPrototypeOf\";\nvar _templateObject, _templateObject2, _templateObject3;\nimport \"core-js/modules/es.error.cause.js\";\nimport \"core-js/modules/es.array.concat.js\";\nimport \"core-js/modules/es.array.find.js\";\nimport \"core-js/modules/es.array.includes.js\";\nimport \"core-js/modules/es.array.iterator.js\";\nimport \"core-js/modules/es.array.map.js\";\nimport \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.function.name.js\";\nimport \"core-js/modules/es.number.constructor.js\";\nimport \"core-js/modules/es.number.to-fixed.js\";\nimport \"core-js/modules/es.object.keys.js\";\nimport \"core-js/modules/es.object.to-string.js\";\nimport \"core-js/modules/es.object.values.js\";\nimport \"core-js/modules/es.promise.js\";\nimport \"core-js/modules/es.string.includes.js\";\nimport \"core-js/modules/es.string.iterator.js\";\nimport \"core-js/modules/esnext.iterator.constructor.js\";\nimport \"core-js/modules/esnext.iterator.find.js\";\nimport \"core-js/modules/esnext.iterator.map.js\";\nimport \"core-js/modules/web.dom-collections.iterator.js\";\nvar mdiImageFilterCenterFocus = \"M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M19,19H15V21H19A2,2 0 0,0 21,19V15H19M19,3H15V5H19V9H21V5A2,2 0 0,0 19,3M5,5H9V3H5A2,2 0 0,0 3,5V9H5M5,15H3V19A2,2 0 0,0 5,21H9V19H5V15Z\";\nimport { css, html, LitElement, nothing } from \"lit\";\nimport { customElement, property, query, state } from \"lit/decorators\";\nimport memoizeOne from \"memoize-one\";\nimport { getColorByIndex } from \"../../../common/color/colors\";\nimport { isComponentLoaded } from \"../../../common/config/is_component_loaded\";\nimport { computeDomain } from \"../../../common/entity/compute_domain\";\nimport { computeStateName } from \"../../../common/entity/compute_state_name\";\nimport { deepEqual } from \"../../../common/util/deep-equal\";\nimport parseAspectRatio from \"../../../common/util/parse-aspect-ratio\";\nimport \"../../../components/ha-card\";\nimport \"../../../components/ha-alert\";\nimport \"../../../components/ha-icon-button\";\nimport \"../../../components/map/ha-map\";\nimport { subscribeHistoryStatesTimeWindow } from \"../../../data/history\";\nimport { hasConfigChanged, hasConfigOrEntitiesChanged } from \"../common/has-changed\";\nimport { findEntities } from \"../common/find-entities\";\nimport { processConfigEntities } from \"../common/process-config-entities\";\nexport var DEFAULT_HOURS_TO_SHOW = 0;\nexport var DEFAULT_ZOOM = 14;\nvar HuiMapCard = _decorate([customElement(\"hui-map-card\")], function (_initialize, _LitElement) {\n  var HuiMapCard = /*#__PURE__*/function (_LitElement2) {\n    _inherits(HuiMapCard, _LitElement2);\n    function HuiMapCard() {\n      var _this;\n      _classCallCheck(this, HuiMapCard);\n      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n        args[_key] = arguments[_key];\n      }\n      _this = _callSuper(this, HuiMapCard, [].concat(args));\n      _initialize(_assertThisInitialized(_this));\n      return _this;\n    }\n    return _createClass(HuiMapCard);\n  }(_LitElement);\n  return {\n    F: HuiMapCard,\n    d: [{\n      kind: \"field\",\n      decorators: [property({\n        attribute: false\n      })],\n      key: \"hass\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [property({\n        type: Boolean,\n        reflect: true\n      })],\n      key: \"isPanel\",\n      value: function value() {\n        return false;\n      }\n    }, {\n      kind: \"field\",\n      decorators: [state()],\n      key: \"_stateHistory\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [state()],\n      key: \"_config\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [query(\"ha-map\")],\n      key: \"_map\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      key: \"_configEntities\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      decorators: [state()],\n      key: \"_mapEntities\",\n      value: function value() {\n        return [];\n      }\n    }, {\n      kind: \"field\",\n      key: \"_colorDict\",\n      value: function value() {\n        return {};\n      }\n    }, {\n      kind: \"field\",\n      key: \"_colorIndex\",\n      value: function value() {\n        return 0;\n      }\n    }, {\n      kind: \"field\",\n      decorators: [state()],\n      key: \"_error\",\n      value: void 0\n    }, {\n      kind: \"field\",\n      key: \"_subscribed\",\n      value: void 0\n    }, {\n      kind: \"method\",\n      key: \"setConfig\",\n      value: function setConfig(config) {\n        var _config$entities;\n        if (!config) {\n          throw new Error(\"Error in card configuration.\");\n        }\n        if (!((_config$entities = config.entities) !== null && _config$entities !== void 0 && _config$entities.length) && !config.geo_location_sources) {\n          throw new Error(\"Either entities or geo_location_sources must be specified\");\n        }\n        if (config.entities && !Array.isArray(config.entities)) {\n          throw new Error(\"Entities need to be an array\");\n        }\n        if (config.geo_location_sources && !Array.isArray(config.geo_location_sources)) {\n          throw new Error(\"Parameter geo_location_sources needs to be an array\");\n        }\n        this._config = config;\n        this._configEntities = config.entities ? processConfigEntities(config.entities) : [];\n        this._mapEntities = this._getMapEntities();\n      }\n    }, {\n      kind: \"method\",\n      key: \"getCardSize\",\n      value: function getCardSize() {\n        var _this$_config;\n        if (!((_this$_config = this._config) !== null && _this$_config !== void 0 && _this$_config.aspect_ratio)) {\n          return 7;\n        }\n        var ratio = parseAspectRatio(this._config.aspect_ratio);\n        var ar = ratio && ratio.w > 0 && ratio.h > 0 ? \"\".concat((100 * ratio.h / ratio.w).toFixed(2)) : \"100\";\n        return 1 + Math.floor(Number(ar) / 25) || 3;\n      }\n    }, {\n      kind: \"method\",\n      static: true,\n      key: \"getConfigElement\",\n      value: function () {\n        var _getConfigElement = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee() {\n          return _regeneratorRuntime().wrap(function _callee$(_context) {\n            while (1) switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return import(\"../editor/config-elements/hui-map-card-editor\");\n              case 2:\n                return _context.abrupt(\"return\", document.createElement(\"hui-map-card-editor\"));\n              case 3:\n              case \"end\":\n                return _context.stop();\n            }\n          }, _callee);\n        }));\n        function getConfigElement() {\n          return _getConfigElement.apply(this, arguments);\n        }\n        return getConfigElement;\n      }()\n    }, {\n      kind: \"method\",\n      static: true,\n      key: \"getStubConfig\",\n      value: function getStubConfig(hass, entities, entitiesFallback) {\n        var includeDomains = [\"device_tracker\"];\n        var maxEntities = 2;\n        var foundEntities = findEntities(hass, maxEntities, entities, entitiesFallback, includeDomains);\n        return {\n          type: \"map\",\n          entities: foundEntities\n        };\n      }\n    }, {\n      kind: \"method\",\n      key: \"render\",\n      value: function render() {\n        var _this$_config$default;\n        if (!this._config) {\n          return nothing;\n        }\n        if (this._error) {\n          return html(_templateObject || (_templateObject = _taggedTemplateLiteral([\"<ha-alert alert-type=\\\"error\\\">\\n        \", \": \", \"\\n        (\", \")\\n      </ha-alert>\"])), this.hass.localize(\"ui.components.map.error\"), this._error.message, this._error.code);\n        }\n        return html(_templateObject2 || (_templateObject2 = _taggedTemplateLiteral([\"\\n      <ha-card id=\\\"card\\\" .header=\", \">\\n        <div id=\\\"root\\\">\\n          <ha-map\\n            .hass=\", \"\\n            .entities=\", \"\\n            .zoom=\", \"\\n            .paths=\", \"\\n            .autoFit=\", \"\\n            .fitZones=\", \"\\n            ?darkMode=\", \"\\n            interactiveZones\\n            renderPassive\\n          ></ha-map>\\n          <ha-icon-button\\n            .label=\", \"\\n            .path=\", \"\\n            @click=\", \"\\n            tabindex=\\\"0\\\"\\n          ></ha-icon-button>\\n        </div>\\n      </ha-card>\\n    \"])), this._config.title, this.hass, this._mapEntities, (_this$_config$default = this._config.default_zoom) !== null && _this$_config$default !== void 0 ? _this$_config$default : DEFAULT_ZOOM, this._getHistoryPaths(this._config, this._stateHistory), this._config.auto_fit || false, this._config.fit_zones, this._config.dark_mode, this.hass.localize(\"ui.panel.lovelace.cards.map.reset_focus\"), mdiImageFilterCenterFocus, this._fitMap);\n      }\n    }, {\n      kind: \"method\",\n      key: \"shouldUpdate\",\n      value: function shouldUpdate(changedProps) {\n        var _this$_config2, _this$_config3;\n        if (!changedProps.has(\"hass\") || changedProps.size > 1) {\n          return true;\n        }\n        var oldHass = changedProps.get(\"hass\");\n        if (!oldHass || !this._configEntities) {\n          return true;\n        }\n        if (oldHass.themes.darkMode !== this.hass.themes.darkMode) {\n          return true;\n        }\n        if (changedProps.has(\"_stateHistory\")) {\n          return true;\n        }\n        if ((_this$_config2 = this._config) !== null && _this$_config2 !== void 0 && _this$_config2.geo_location_sources) {\n          if (oldHass.states !== this.hass.states) {\n            return true;\n          }\n        }\n        return (_this$_config3 = this._config) !== null && _this$_config3 !== void 0 && _this$_config3.entities ? hasConfigOrEntitiesChanged(this, changedProps) : hasConfigChanged(this, changedProps);\n      }\n    }, {\n      kind: \"method\",\n      key: \"willUpdate\",\n      value: function willUpdate(changedProps) {\n        var _this$_config4, _changedProps$get;\n        _get(_getPrototypeOf(HuiMapCard.prototype), \"willUpdate\", this).call(this, changedProps);\n        if (changedProps.has(\"hass\") && (_this$_config4 = this._config) !== null && _this$_config4 !== void 0 && _this$_config4.geo_location_sources && !deepEqual(this._getSourceEntities((_changedProps$get = changedProps.get(\"hass\")) === null || _changedProps$get === void 0 ? void 0 : _changedProps$get.states), this._getSourceEntities(this.hass.states))) {\n          this._mapEntities = this._getMapEntities();\n        }\n      }\n    }, {\n      kind: \"method\",\n      key: \"connectedCallback\",\n      value: function connectedCallback() {\n        var _this$_configEntities;\n        _get(_getPrototypeOf(HuiMapCard.prototype), \"connectedCallback\", this).call(this);\n        if (this.hasUpdated && (_this$_configEntities = this._configEntities) !== null && _this$_configEntities !== void 0 && _this$_configEntities.length) {\n          this._subscribeHistory();\n        }\n      }\n    }, {\n      kind: \"method\",\n      key: \"disconnectedCallback\",\n      value: function disconnectedCallback() {\n        _get(_getPrototypeOf(HuiMapCard.prototype), \"disconnectedCallback\", this).call(this);\n        this._unsubscribeHistory();\n      }\n    }, {\n      kind: \"method\",\n      key: \"_subscribeHistory\",\n      value: function _subscribeHistory() {\n        var _this$_config$hours_t,\n          _this$_config5,\n          _this2 = this,\n          _ref;\n        if (!isComponentLoaded(this.hass, \"history\") || this._subscribed || !((_this$_config$hours_t = (_this$_config5 = this._config) === null || _this$_config5 === void 0 ? void 0 : _this$_config5.hours_to_show) !== null && _this$_config$hours_t !== void 0 ? _this$_config$hours_t : DEFAULT_HOURS_TO_SHOW)) {\n          return;\n        }\n        this._subscribed = subscribeHistoryStatesTimeWindow(this.hass, function (combinedHistory) {\n          if (!_this2._subscribed) {\n            // Message came in before we had a chance to unload\n            return;\n          }\n          _this2._stateHistory = combinedHistory;\n        }, (_ref = this._config.hours_to_show) !== null && _ref !== void 0 ? _ref : DEFAULT_HOURS_TO_SHOW, (this._configEntities || []).map(function (entity) {\n          return entity.entity;\n        }), false, false, false).catch(function (err) {\n          _this2._subscribed = undefined;\n          _this2._error = err;\n        });\n      }\n    }, {\n      kind: \"method\",\n      key: \"_unsubscribeHistory\",\n      value: function _unsubscribeHistory() {\n        if (this._subscribed) {\n          this._subscribed.then(function (unsub) {\n            return unsub === null || unsub === void 0 ? void 0 : unsub();\n          });\n          this._subscribed = undefined;\n        }\n      }\n    }, {\n      kind: \"method\",\n      key: \"updated\",\n      value: function updated(changedProps) {\n        var _this$_configEntities2;\n        if ((_this$_configEntities2 = this._configEntities) !== null && _this$_configEntities2 !== void 0 && _this$_configEntities2.length) {\n          if (!this._subscribed || changedProps.has(\"_config\")) {\n            this._unsubscribeHistory();\n            this._subscribeHistory();\n          }\n        } else {\n          this._unsubscribeHistory();\n        }\n        if (changedProps.has(\"_config\")) {\n          this._computePadding();\n        }\n      }\n    }, {\n      kind: \"method\",\n      key: \"_computePadding\",\n      value: function _computePadding() {\n        var root = this.shadowRoot.getElementById(\"root\");\n        if (!this._config || this.isPanel || !root) {\n          return;\n        }\n        if (!this._config.aspect_ratio) {\n          root.style.paddingBottom = \"100%\";\n          return;\n        }\n        root.style.height = \"auto\";\n        var ratio = parseAspectRatio(this._config.aspect_ratio);\n        root.style.paddingBottom = ratio && ratio.w > 0 && ratio.h > 0 ? \"\".concat((100 * ratio.h / ratio.w).toFixed(2), \"%\") : root.style.paddingBottom = \"100%\";\n      }\n    }, {\n      kind: \"method\",\n      key: \"_fitMap\",\n      value: function _fitMap() {\n        var _this$_map;\n        (_this$_map = this._map) === null || _this$_map === void 0 || _this$_map.fitMap();\n      }\n    }, {\n      kind: \"method\",\n      key: \"_getColor\",\n      value: function _getColor(entityId) {\n        var color = this._colorDict[entityId];\n        if (color) {\n          return color;\n        }\n        color = getColorByIndex(this._colorIndex);\n        this._colorIndex++;\n        this._colorDict[entityId] = color;\n        return color;\n      }\n    }, {\n      kind: \"method\",\n      key: \"_getSourceEntities\",\n      value: function _getSourceEntities(states) {\n        var _this$_config6;\n        if (!states || !((_this$_config6 = this._config) !== null && _this$_config6 !== void 0 && _this$_config6.geo_location_sources)) {\n          return [];\n        }\n        var geoEntities = [];\n        // Calculate visible geo location sources\n        var includesAll = this._config.geo_location_sources.includes(\"all\");\n        for (var _i = 0, _Object$values = Object.values(states); _i < _Object$values.length; _i++) {\n          var stateObj = _Object$values[_i];\n          if (computeDomain(stateObj.entity_id) === \"geo_location\" && (includesAll || this._config.geo_location_sources.includes(stateObj.attributes.source))) {\n            geoEntities.push(stateObj.entity_id);\n          }\n        }\n        return geoEntities;\n      }\n    }, {\n      kind: \"method\",\n      key: \"_getMapEntities\",\n      value: function _getMapEntities() {\n        var _this3 = this,\n          _this$hass;\n        return [].concat(_toConsumableArray((this._configEntities || []).map(function (entityConf) {\n          return {\n            entity_id: entityConf.entity,\n            color: _this3._getColor(entityConf.entity),\n            label_mode: entityConf.label_mode,\n            focus: entityConf.focus,\n            name: entityConf.name\n          };\n        })), _toConsumableArray(this._getSourceEntities((_this$hass = this.hass) === null || _this$hass === void 0 ? void 0 : _this$hass.states).map(function (entity) {\n          return {\n            entity_id: entity,\n            color: _this3._getColor(entity)\n          };\n        })));\n      }\n    }, {\n      kind: \"field\",\n      key: \"_getHistoryPaths\",\n      value: function value() {\n        var _this4 = this;\n        return memoizeOne(function (config, history) {\n          var _config$hours_to_show;\n          if (!history || !((_config$hours_to_show = config.hours_to_show) !== null && _config$hours_to_show !== void 0 ? _config$hours_to_show : DEFAULT_HOURS_TO_SHOW)) {\n            return undefined;\n          }\n          var paths = [];\n          var _loop = function _loop() {\n              var _this4$_configEntitie, _entityConfig$name, _config$hours_to_show2;\n              var entityId = _Object$keys[_i2];\n              if (computeDomain(entityId) === \"zone\") {\n                return 0; // continue\n              }\n              var entityStates = history[entityId];\n              if (!(entityStates !== null && entityStates !== void 0 && entityStates.length)) {\n                return 0; // continue\n              }\n              // filter location data from states and remove all invalid locations\n              var points = [];\n              var _iterator = _createForOfIteratorHelper(entityStates),\n                _step;\n              try {\n                for (_iterator.s(); !(_step = _iterator.n()).done;) {\n                  var entityState = _step.value;\n                  var latitude = entityState.a.latitude;\n                  var longitude = entityState.a.longitude;\n                  if (!latitude || !longitude) {\n                    continue;\n                  }\n                  var p = {};\n                  p.point = [latitude, longitude];\n                  p.timestamp = new Date(entityState.lu * 1000);\n                  points.push(p);\n                }\n              } catch (err) {\n                _iterator.e(err);\n              } finally {\n                _iterator.f();\n              }\n              var entityConfig = (_this4$_configEntitie = _this4._configEntities) === null || _this4$_configEntitie === void 0 ? void 0 : _this4$_configEntitie.find(function (e) {\n                return e.entity === entityId;\n              });\n              var name = (_entityConfig$name = entityConfig === null || entityConfig === void 0 ? void 0 : entityConfig.name) !== null && _entityConfig$name !== void 0 ? _entityConfig$name : entityId in _this4.hass.states ? computeStateName(_this4.hass.states[entityId]) : entityId;\n              paths.push({\n                points: points,\n                name: name,\n                fullDatetime: ((_config$hours_to_show2 = config.hours_to_show) !== null && _config$hours_to_show2 !== void 0 ? _config$hours_to_show2 : DEFAULT_HOURS_TO_SHOW) > 144,\n                color: _this4._getColor(entityId),\n                gradualOpacity: 0.8\n              });\n            },\n            _ret;\n          for (var _i2 = 0, _Object$keys = Object.keys(history); _i2 < _Object$keys.length; _i2++) {\n            _ret = _loop();\n            if (_ret === 0) continue;\n          }\n          return paths;\n        });\n      }\n    }, {\n      kind: \"get\",\n      static: true,\n      key: \"styles\",\n      value: function styles() {\n        return css(_templateObject3 || (_templateObject3 = _taggedTemplateLiteral([\"\\n      ha-card {\\n        overflow: hidden;\\n        width: 100%;\\n        height: 100%;\\n        display: flex;\\n        flex-direction: column;\\n      }\\n\\n      ha-map {\\n        z-index: 0;\\n        border: none;\\n        position: absolute;\\n        top: 0;\\n        left: 0;\\n        width: 100%;\\n        height: 100%;\\n        background: inherit;\\n      }\\n\\n      ha-icon-button {\\n        position: absolute;\\n        top: 75px;\\n        left: 3px;\\n        outline: none;\\n      }\\n\\n      #root {\\n        position: relative;\\n        height: 100%;\\n      }\\n    \"])));\n      }\n    }]\n  };\n}, LitElement);","map":{"version":3,"names":["css","html","LitElement","nothing","customElement","property","query","state","memoizeOne","getColorByIndex","isComponentLoaded","computeDomain","computeStateName","deepEqual","parseAspectRatio","subscribeHistoryStatesTimeWindow","hasConfigChanged","hasConfigOrEntitiesChanged","findEntities","processConfigEntities","DEFAULT_HOURS_TO_SHOW","DEFAULT_ZOOM","HuiMapCard","_decorate","_initialize","_LitElement","_LitElement2","_inherits","_this","_classCallCheck","_len","arguments","length","args","Array","_key","_callSuper","concat","_assertThisInitialized","_createClass","F","d","kind","decorators","attribute","key","value","type","Boolean","reflect","setConfig","config","_config$entities","Error","entities","geo_location_sources","isArray","_config","_configEntities","_mapEntities","_getMapEntities","getCardSize","_this$_config","aspect_ratio","ratio","ar","w","h","toFixed","Math","floor","Number","static","_getConfigElement","_asyncToGenerator","_regeneratorRuntime","mark","_callee","wrap","_callee$","_context","prev","next","abrupt","document","createElement","stop","getConfigElement","apply","getStubConfig","hass","entitiesFallback","includeDomains","maxEntities","foundEntities","render","_this$_config$default","_error","_templateObject","_taggedTemplateLiteral","localize","message","code","_templateObject2","title","default_zoom","_getHistoryPaths","_stateHistory","auto_fit","fit_zones","dark_mode","mdiImageFilterCenterFocus","_fitMap","shouldUpdate","changedProps","_this$_config2","_this$_config3","has","size","oldHass","get","themes","darkMode","states","willUpdate","_this$_config4","_changedProps$get","_get","_getPrototypeOf","prototype","call","_getSourceEntities","connectedCallback","_this$_configEntities","hasUpdated","_subscribeHistory","disconnectedCallback","_unsubscribeHistory","_this$_config$hours_t","_this$_config5","_this2","_ref","_subscribed","hours_to_show","combinedHistory","map","entity","catch","err","undefined","then","unsub","updated","_this$_configEntities2","_computePadding","root","shadowRoot","getElementById","isPanel","style","paddingBottom","height","_this$_map","_map","fitMap","_getColor","entityId","color","_colorDict","_colorIndex","_this$_config6","geoEntities","includesAll","includes","_i","_Object$values","Object","values","stateObj","entity_id","attributes","source","push","_this3","_this$hass","_toConsumableArray","entityConf","label_mode","focus","name","_this4","history","_config$hours_to_show","paths","_loop","_this4$_configEntitie","_entityConfig$name","_config$hours_to_show2","_Object$keys","_i2","entityStates","points","_iterator","_createForOfIteratorHelper","_step","s","n","done","entityState","latitude","a","longitude","p","point","timestamp","Date","lu","e","f","entityConfig","find","fullDatetime","gradualOpacity","_ret","keys","styles","_templateObject3"],"sources":["/workspaces/frontend/src/panels/lovelace/cards/hui-map-card.ts"],"sourcesContent":["import { mdiImageFilterCenterFocus } from \"@mdi/js\";\nimport { HassEntities } from \"home-assistant-js-websocket\";\nimport { LatLngTuple } from \"leaflet\";\nimport {\n  css,\n  CSSResultGroup,\n  html,\n  LitElement,\n  PropertyValues,\n  nothing,\n} from \"lit\";\nimport { customElement, property, query, state } from \"lit/decorators\";\nimport memoizeOne from \"memoize-one\";\nimport { getColorByIndex } from \"../../../common/color/colors\";\nimport { isComponentLoaded } from \"../../../common/config/is_component_loaded\";\nimport { computeDomain } from \"../../../common/entity/compute_domain\";\nimport { computeStateName } from \"../../../common/entity/compute_state_name\";\nimport { deepEqual } from \"../../../common/util/deep-equal\";\nimport parseAspectRatio from \"../../../common/util/parse-aspect-ratio\";\nimport \"../../../components/ha-card\";\nimport \"../../../components/ha-alert\";\nimport \"../../../components/ha-icon-button\";\nimport \"../../../components/map/ha-map\";\nimport type {\n  HaMap,\n  HaMapEntity,\n  HaMapPathPoint,\n  HaMapPaths,\n} from \"../../../components/map/ha-map\";\nimport {\n  HistoryStates,\n  subscribeHistoryStatesTimeWindow,\n} from \"../../../data/history\";\nimport {\n  hasConfigChanged,\n  hasConfigOrEntitiesChanged,\n} from \"../common/has-changed\";\nimport { HomeAssistant } from \"../../../types\";\nimport { findEntities } from \"../common/find-entities\";\nimport { processConfigEntities } from \"../common/process-config-entities\";\nimport { EntityConfig } from \"../entity-rows/types\";\nimport { LovelaceCard } from \"../types\";\nimport { MapCardConfig } from \"./types\";\n\nexport const DEFAULT_HOURS_TO_SHOW = 0;\nexport const DEFAULT_ZOOM = 14;\n\ninterface MapEntityConfig extends EntityConfig {\n  label_mode?: \"state\" | \"name\";\n  focus?: boolean;\n}\n\n@customElement(\"hui-map-card\")\nclass HuiMapCard extends LitElement implements LovelaceCard {\n  @property({ attribute: false }) public hass!: HomeAssistant;\n\n  @property({ type: Boolean, reflect: true })\n  public isPanel = false;\n\n  @state() private _stateHistory?: HistoryStates;\n\n  @state()\n  private _config?: MapCardConfig;\n\n  @query(\"ha-map\")\n  private _map?: HaMap;\n\n  private _configEntities?: MapEntityConfig[];\n\n  @state() private _mapEntities: HaMapEntity[] = [];\n\n  private _colorDict: Record<string, string> = {};\n\n  private _colorIndex = 0;\n\n  @state() private _error?: { code: string; message: string };\n\n  private _subscribed?: Promise<(() => Promise<void>) | void>;\n\n  public setConfig(config: MapCardConfig): void {\n    if (!config) {\n      throw new Error(\"Error in card configuration.\");\n    }\n\n    if (!config.entities?.length && !config.geo_location_sources) {\n      throw new Error(\n        \"Either entities or geo_location_sources must be specified\"\n      );\n    }\n    if (config.entities && !Array.isArray(config.entities)) {\n      throw new Error(\"Entities need to be an array\");\n    }\n    if (\n      config.geo_location_sources &&\n      !Array.isArray(config.geo_location_sources)\n    ) {\n      throw new Error(\"Parameter geo_location_sources needs to be an array\");\n    }\n\n    this._config = config;\n    this._configEntities = config.entities\n      ? processConfigEntities<MapEntityConfig>(config.entities)\n      : [];\n    this._mapEntities = this._getMapEntities();\n  }\n\n  public getCardSize(): number {\n    if (!this._config?.aspect_ratio) {\n      return 7;\n    }\n\n    const ratio = parseAspectRatio(this._config.aspect_ratio);\n    const ar =\n      ratio && ratio.w > 0 && ratio.h > 0\n        ? `${((100 * ratio.h) / ratio.w).toFixed(2)}`\n        : \"100\";\n\n    return 1 + Math.floor(Number(ar) / 25) || 3;\n  }\n\n  public static async getConfigElement() {\n    await import(\"../editor/config-elements/hui-map-card-editor\");\n    return document.createElement(\"hui-map-card-editor\");\n  }\n\n  public static getStubConfig(\n    hass: HomeAssistant,\n    entities: string[],\n    entitiesFallback: string[]\n  ): MapCardConfig {\n    const includeDomains = [\"device_tracker\"];\n    const maxEntities = 2;\n    const foundEntities = findEntities(\n      hass,\n      maxEntities,\n      entities,\n      entitiesFallback,\n      includeDomains\n    );\n\n    return { type: \"map\", entities: foundEntities };\n  }\n\n  protected render() {\n    if (!this._config) {\n      return nothing;\n    }\n    if (this._error) {\n      return html`<ha-alert alert-type=\"error\">\n        ${this.hass.localize(\"ui.components.map.error\")}: ${this._error.message}\n        (${this._error.code})\n      </ha-alert>`;\n    }\n    return html`\n      <ha-card id=\"card\" .header=${this._config.title}>\n        <div id=\"root\">\n          <ha-map\n            .hass=${this.hass}\n            .entities=${this._mapEntities}\n            .zoom=${this._config.default_zoom ?? DEFAULT_ZOOM}\n            .paths=${this._getHistoryPaths(this._config, this._stateHistory)}\n            .autoFit=${this._config.auto_fit || false}\n            .fitZones=${this._config.fit_zones}\n            ?darkMode=${this._config.dark_mode}\n            interactiveZones\n            renderPassive\n          ></ha-map>\n          <ha-icon-button\n            .label=${this.hass!.localize(\n              \"ui.panel.lovelace.cards.map.reset_focus\"\n            )}\n            .path=${mdiImageFilterCenterFocus}\n            @click=${this._fitMap}\n            tabindex=\"0\"\n          ></ha-icon-button>\n        </div>\n      </ha-card>\n    `;\n  }\n\n  protected shouldUpdate(changedProps: PropertyValues) {\n    if (!changedProps.has(\"hass\") || changedProps.size > 1) {\n      return true;\n    }\n\n    const oldHass = changedProps.get(\"hass\") as HomeAssistant | undefined;\n\n    if (!oldHass || !this._configEntities) {\n      return true;\n    }\n\n    if (oldHass.themes.darkMode !== this.hass.themes.darkMode) {\n      return true;\n    }\n\n    if (changedProps.has(\"_stateHistory\")) {\n      return true;\n    }\n\n    if (this._config?.geo_location_sources) {\n      if (oldHass.states !== this.hass.states) {\n        return true;\n      }\n    }\n\n    return this._config?.entities\n      ? hasConfigOrEntitiesChanged(this, changedProps)\n      : hasConfigChanged(this, changedProps);\n  }\n\n  protected willUpdate(changedProps: PropertyValues): void {\n    super.willUpdate(changedProps);\n    if (\n      changedProps.has(\"hass\") &&\n      this._config?.geo_location_sources &&\n      !deepEqual(\n        this._getSourceEntities(changedProps.get(\"hass\")?.states),\n        this._getSourceEntities(this.hass.states)\n      )\n    ) {\n      this._mapEntities = this._getMapEntities();\n    }\n  }\n\n  public connectedCallback() {\n    super.connectedCallback();\n    if (this.hasUpdated && this._configEntities?.length) {\n      this._subscribeHistory();\n    }\n  }\n\n  public disconnectedCallback() {\n    super.disconnectedCallback();\n    this._unsubscribeHistory();\n  }\n\n  private _subscribeHistory() {\n    if (\n      !isComponentLoaded(this.hass!, \"history\") ||\n      this._subscribed ||\n      !(this._config?.hours_to_show ?? DEFAULT_HOURS_TO_SHOW)\n    ) {\n      return;\n    }\n    this._subscribed = subscribeHistoryStatesTimeWindow(\n      this.hass!,\n      (combinedHistory) => {\n        if (!this._subscribed) {\n          // Message came in before we had a chance to unload\n          return;\n        }\n        this._stateHistory = combinedHistory;\n      },\n      this._config!.hours_to_show! ?? DEFAULT_HOURS_TO_SHOW,\n      (this._configEntities || []).map((entity) => entity.entity)!,\n      false,\n      false,\n      false\n    ).catch((err) => {\n      this._subscribed = undefined;\n      this._error = err;\n    });\n  }\n\n  private _unsubscribeHistory() {\n    if (this._subscribed) {\n      this._subscribed.then((unsub) => unsub?.());\n      this._subscribed = undefined;\n    }\n  }\n\n  protected updated(changedProps: PropertyValues): void {\n    if (this._configEntities?.length) {\n      if (!this._subscribed || changedProps.has(\"_config\")) {\n        this._unsubscribeHistory();\n        this._subscribeHistory();\n      }\n    } else {\n      this._unsubscribeHistory();\n    }\n    if (changedProps.has(\"_config\")) {\n      this._computePadding();\n    }\n  }\n\n  private _computePadding(): void {\n    const root = this.shadowRoot!.getElementById(\"root\");\n    if (!this._config || this.isPanel || !root) {\n      return;\n    }\n\n    if (!this._config.aspect_ratio) {\n      root.style.paddingBottom = \"100%\";\n      return;\n    }\n\n    root.style.height = \"auto\";\n\n    const ratio = parseAspectRatio(this._config.aspect_ratio);\n\n    root.style.paddingBottom =\n      ratio && ratio.w > 0 && ratio.h > 0\n        ? `${((100 * ratio.h) / ratio.w).toFixed(2)}%`\n        : (root.style.paddingBottom = \"100%\");\n  }\n\n  private _fitMap() {\n    this._map?.fitMap();\n  }\n\n  private _getColor(entityId: string): string {\n    let color = this._colorDict[entityId];\n    if (color) {\n      return color;\n    }\n    color = getColorByIndex(this._colorIndex);\n    this._colorIndex++;\n    this._colorDict[entityId] = color;\n    return color;\n  }\n\n  private _getSourceEntities(states?: HassEntities): string[] {\n    if (!states || !this._config?.geo_location_sources) {\n      return [];\n    }\n\n    const geoEntities: string[] = [];\n    // Calculate visible geo location sources\n    const includesAll = this._config.geo_location_sources.includes(\"all\");\n    for (const stateObj of Object.values(states)) {\n      if (\n        computeDomain(stateObj.entity_id) === \"geo_location\" &&\n        (includesAll ||\n          this._config.geo_location_sources.includes(\n            stateObj.attributes.source\n          ))\n      ) {\n        geoEntities.push(stateObj.entity_id);\n      }\n    }\n    return geoEntities;\n  }\n\n  private _getMapEntities(): HaMapEntity[] {\n    return [\n      ...(this._configEntities || []).map((entityConf) => ({\n        entity_id: entityConf.entity,\n        color: this._getColor(entityConf.entity),\n        label_mode: entityConf.label_mode,\n        focus: entityConf.focus,\n        name: entityConf.name,\n      })),\n      ...this._getSourceEntities(this.hass?.states).map((entity) => ({\n        entity_id: entity,\n        color: this._getColor(entity),\n      })),\n    ];\n  }\n\n  private _getHistoryPaths = memoizeOne(\n    (\n      config: MapCardConfig,\n      history?: HistoryStates\n    ): HaMapPaths[] | undefined => {\n      if (!history || !(config.hours_to_show ?? DEFAULT_HOURS_TO_SHOW)) {\n        return undefined;\n      }\n\n      const paths: HaMapPaths[] = [];\n\n      for (const entityId of Object.keys(history)) {\n        if (computeDomain(entityId) === \"zone\") {\n          continue;\n        }\n        const entityStates = history[entityId];\n        if (!entityStates?.length) {\n          continue;\n        }\n        // filter location data from states and remove all invalid locations\n        const points: HaMapPathPoint[] = [];\n        for (const entityState of entityStates) {\n          const latitude = entityState.a.latitude;\n          const longitude = entityState.a.longitude;\n          if (!latitude || !longitude) {\n            continue;\n          }\n          const p = {} as HaMapPathPoint;\n          p.point = [latitude, longitude] as LatLngTuple;\n          p.timestamp = new Date(entityState.lu * 1000);\n          points.push(p);\n        }\n\n        const entityConfig = this._configEntities?.find(\n          (e) => e.entity === entityId\n        );\n        const name =\n          entityConfig?.name ??\n          (entityId in this.hass.states\n            ? computeStateName(this.hass.states[entityId])\n            : entityId);\n\n        paths.push({\n          points,\n          name,\n          fullDatetime: (config.hours_to_show ?? DEFAULT_HOURS_TO_SHOW) > 144,\n          color: this._getColor(entityId),\n          gradualOpacity: 0.8,\n        });\n      }\n      return paths;\n    }\n  );\n\n  static get styles(): CSSResultGroup {\n    return css`\n      ha-card {\n        overflow: hidden;\n        width: 100%;\n        height: 100%;\n        display: flex;\n        flex-direction: column;\n      }\n\n      ha-map {\n        z-index: 0;\n        border: none;\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: inherit;\n      }\n\n      ha-icon-button {\n        position: absolute;\n        top: 75px;\n        left: 3px;\n        outline: none;\n      }\n\n      #root {\n        position: relative;\n        height: 100%;\n      }\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"hui-map-card\": HuiMapCard;\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGA,SACEA,GAAG,EAEHC,IAAI,EACJC,UAAU,EAEVC,OAAO,QACF,KAAK;AACZ,SAASC,aAAa,EAAEC,QAAQ,EAAEC,KAAK,EAAEC,KAAK,QAAQ,gBAAgB;AACtE,OAAOC,UAAU,MAAM,aAAa;AACpC,SAASC,eAAe,QAAQ,8BAA8B;AAC9D,SAASC,iBAAiB,QAAQ,4CAA4C;AAC9E,SAASC,aAAa,QAAQ,uCAAuC;AACrE,SAASC,gBAAgB,QAAQ,2CAA2C;AAC5E,SAASC,SAAS,QAAQ,iCAAiC;AAC3D,OAAOC,gBAAgB,MAAM,yCAAyC;AACtE,OAAO,6BAA6B;AACpC,OAAO,8BAA8B;AACrC,OAAO,oCAAoC;AAC3C,OAAO,gCAAgC;AAOvC,SAEEC,gCAAgC,QAC3B,uBAAuB;AAC9B,SACEC,gBAAgB,EAChBC,0BAA0B,QACrB,uBAAuB;AAE9B,SAASC,YAAY,QAAQ,yBAAyB;AACtD,SAASC,qBAAqB,QAAQ,mCAAmC;AAKzE,OAAO,IAAMC,qBAAqB,GAAG,CAAC;AACtC,OAAO,IAAMC,YAAY,GAAG,EAAE;AAAC,IAQzBC,UAAU,GAAAC,SAAA,EADfnB,aAAa,CAAC,cAAc,CAAC,aAAAoB,WAAA,EAAAC,WAAA;EAAA,IACxBH,UAAU,0BAAAI,YAAA;IAAAC,SAAA,CAAAL,UAAA,EAAAI,YAAA;IAAA,SAAAJ,WAAA;MAAA,IAAAM,KAAA;MAAAC,eAAA,OAAAP,UAAA;MAAA,SAAAQ,IAAA,GAAAC,SAAA,CAAAC,MAAA,EAAAC,IAAA,OAAAC,KAAA,CAAAJ,IAAA,GAAAK,IAAA,MAAAA,IAAA,GAAAL,IAAA,EAAAK,IAAA;QAAAF,IAAA,CAAAE,IAAA,IAAAJ,SAAA,CAAAI,IAAA;MAAA;MAAAP,KAAA,GAAAQ,UAAA,OAAAd,UAAA,KAAAe,MAAA,CAAAJ,IAAA;MAAAT,WAAA,CAAAc,sBAAA,CAAAV,KAAA;MAAA,OAAAA,KAAA;IAAA;IAAA,OAAAW,YAAA,CAAAjB,UAAA;EAAA,EAAAG,WAAA;EAAA;IAAAe,CAAA,EAAVlB,UAAU;IAAAmB,CAAA;MAAAC,IAAA;MAAAC,UAAA,GACbtC,QAAQ,CAAC;QAAEuC,SAAS,EAAE;MAAM,CAAC,CAAC;MAAAC,GAAA;MAAAC,KAAA;IAAA;MAAAJ,IAAA;MAAAC,UAAA,GAE9BtC,QAAQ,CAAC;QAAE0C,IAAI,EAAEC,OAAO;QAAEC,OAAO,EAAE;MAAK,CAAC,CAAC;MAAAJ,GAAA;MAAAC,KAAA,WAAAA,MAAA;QAAA,OAC1B,KAAK;MAAA;IAAA;MAAAJ,IAAA;MAAAC,UAAA,GAErBpC,KAAK,CAAC,CAAC;MAAAsC,GAAA;MAAAC,KAAA;IAAA;MAAAJ,IAAA;MAAAC,UAAA,GAEPpC,KAAK,CAAC,CAAC;MAAAsC,GAAA;MAAAC,KAAA;IAAA;MAAAJ,IAAA;MAAAC,UAAA,GAGPrC,KAAK,CAAC,QAAQ,CAAC;MAAAuC,GAAA;MAAAC,KAAA;IAAA;MAAAJ,IAAA;MAAAG,GAAA;MAAAC,KAAA;IAAA;MAAAJ,IAAA;MAAAC,UAAA,GAKfpC,KAAK,CAAC,CAAC;MAAAsC,GAAA;MAAAC,KAAA,WAAAA,MAAA;QAAA,OAAuC,EAAE;MAAA;IAAA;MAAAJ,IAAA;MAAAG,GAAA;MAAAC,KAAA,WAAAA,MAAA;QAAA,OAEJ,CAAC,CAAC;MAAA;IAAA;MAAAJ,IAAA;MAAAG,GAAA;MAAAC,KAAA,WAAAA,MAAA;QAAA,OAEzB,CAAC;MAAA;IAAA;MAAAJ,IAAA;MAAAC,UAAA,GAEtBpC,KAAK,CAAC,CAAC;MAAAsC,GAAA;MAAAC,KAAA;IAAA;MAAAJ,IAAA;MAAAG,GAAA;MAAAC,KAAA;IAAA;MAAAJ,IAAA;MAAAG,GAAA;MAAAC,KAAA,EAIR,SAAAI,UAAiBC,MAAqB,EAAQ;QAAA,IAAAC,gBAAA;QAC5C,IAAI,CAACD,MAAM,EAAE;UACX,MAAM,IAAIE,KAAK,CAAC,8BAA8B,CAAC;QACjD;QAEA,IAAI,GAAAD,gBAAA,GAACD,MAAM,CAACG,QAAQ,cAAAF,gBAAA,eAAfA,gBAAA,CAAiBpB,MAAM,KAAI,CAACmB,MAAM,CAACI,oBAAoB,EAAE;UAC5D,MAAM,IAAIF,KAAK,CACb,2DACF,CAAC;QACH;QACA,IAAIF,MAAM,CAACG,QAAQ,IAAI,CAACpB,KAAK,CAACsB,OAAO,CAACL,MAAM,CAACG,QAAQ,CAAC,EAAE;UACtD,MAAM,IAAID,KAAK,CAAC,8BAA8B,CAAC;QACjD;QACA,IACEF,MAAM,CAACI,oBAAoB,IAC3B,CAACrB,KAAK,CAACsB,OAAO,CAACL,MAAM,CAACI,oBAAoB,CAAC,EAC3C;UACA,MAAM,IAAIF,KAAK,CAAC,qDAAqD,CAAC;QACxE;QAEA,IAAI,CAACI,OAAO,GAAGN,MAAM;QACrB,IAAI,CAACO,eAAe,GAAGP,MAAM,CAACG,QAAQ,GAClCnC,qBAAqB,CAAkBgC,MAAM,CAACG,QAAQ,CAAC,GACvD,EAAE;QACN,IAAI,CAACK,YAAY,GAAG,IAAI,CAACC,eAAe,CAAC,CAAC;MAC5C;IAAC;MAAAlB,IAAA;MAAAG,GAAA;MAAAC,KAAA,EAED,SAAAe,YAAA,EAA6B;QAAA,IAAAC,aAAA;QAC3B,IAAI,GAAAA,aAAA,GAAC,IAAI,CAACL,OAAO,cAAAK,aAAA,eAAZA,aAAA,CAAcC,YAAY,GAAE;UAC/B,OAAO,CAAC;QACV;QAEA,IAAMC,KAAK,GAAGlD,gBAAgB,CAAC,IAAI,CAAC2C,OAAO,CAACM,YAAY,CAAC;QACzD,IAAME,EAAE,GACND,KAAK,IAAIA,KAAK,CAACE,CAAC,GAAG,CAAC,IAAIF,KAAK,CAACG,CAAC,GAAG,CAAC,MAAA9B,MAAA,CAC5B,CAAE,GAAG,GAAG2B,KAAK,CAACG,CAAC,GAAIH,KAAK,CAACE,CAAC,EAAEE,OAAO,CAAC,CAAC,CAAC,IACzC,KAAK;QAEX,OAAO,CAAC,GAAGC,IAAI,CAACC,KAAK,CAACC,MAAM,CAACN,EAAE,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC;MAC7C;IAAC;MAAAvB,IAAA;MAAA8B,MAAA;MAAA3B,GAAA;MAAAC,KAAA;QAAA,IAAA2B,iBAAA,GAAAC,iBAAA,eAAAC,mBAAA,GAAAC,IAAA,CAED,SAAAC,QAAA;UAAA,OAAAF,mBAAA,GAAAG,IAAA,UAAAC,SAAAC,QAAA;YAAA,kBAAAA,QAAA,CAAAC,IAAA,GAAAD,QAAA,CAAAE,IAAA;cAAA;gBAAAF,QAAA,CAAAE,IAAA;gBAAA,OACQ,MAAM,CAAC,+CAA+C,CAAC;cAAA;gBAAA,OAAAF,QAAA,CAAAG,MAAA,WACtDC,QAAQ,CAACC,aAAa,CAAC,qBAAqB,CAAC;cAAA;cAAA;gBAAA,OAAAL,QAAA,CAAAM,IAAA;YAAA;UAAA,GAAAT,OAAA;QAAA,CACrD;QAAA,SAAAU,iBAAA;UAAA,OAAAd,iBAAA,CAAAe,KAAA,OAAAzD,SAAA;QAAA;QAAA,OAAAwD,gBAAA;MAAA;IAAA;MAAA7C,IAAA;MAAA8B,MAAA;MAAA3B,GAAA;MAAAC,KAAA,EAED,SAAA2C,cACEC,IAAmB,EACnBpC,QAAkB,EAClBqC,gBAA0B,EACX;QACf,IAAMC,cAAc,GAAG,CAAC,gBAAgB,CAAC;QACzC,IAAMC,WAAW,GAAG,CAAC;QACrB,IAAMC,aAAa,GAAG5E,YAAY,CAChCwE,IAAI,EACJG,WAAW,EACXvC,QAAQ,EACRqC,gBAAgB,EAChBC,cACF,CAAC;QAED,OAAO;UAAE7C,IAAI,EAAE,KAAK;UAAEO,QAAQ,EAAEwC;QAAc,CAAC;MACjD;IAAC;MAAApD,IAAA;MAAAG,GAAA;MAAAC,KAAA,EAED,SAAAiD,OAAA,EAAmB;QAAA,IAAAC,qBAAA;QACjB,IAAI,CAAC,IAAI,CAACvC,OAAO,EAAE;UACjB,OAAOtD,OAAO;QAChB;QACA,IAAI,IAAI,CAAC8F,MAAM,EAAE;UACf,OAAOhG,IAAI,CAAAiG,eAAA,KAAAA,eAAA,GAAAC,sBAAA,+FACP,IAAI,CAACT,IAAI,CAACU,QAAQ,CAAC,yBAAyB,CAAC,EAAK,IAAI,CAACH,MAAM,CAACI,OAAO,EACpE,IAAI,CAACJ,MAAM,CAACK,IAAI;QAEvB;QACA,OAAOrG,IAAI,CAAAsG,gBAAA,KAAAA,gBAAA,GAAAJ,sBAAA,+iBACoB,IAAI,CAAC1C,OAAO,CAAC+C,KAAK,EAGjC,IAAI,CAACd,IAAI,EACL,IAAI,CAAC/B,YAAY,GAAAqC,qBAAA,GACrB,IAAI,CAACvC,OAAO,CAACgD,YAAY,cAAAT,qBAAA,cAAAA,qBAAA,GAAI3E,YAAY,EACxC,IAAI,CAACqF,gBAAgB,CAAC,IAAI,CAACjD,OAAO,EAAE,IAAI,CAACkD,aAAa,CAAC,EACrD,IAAI,CAAClD,OAAO,CAACmD,QAAQ,IAAI,KAAK,EAC7B,IAAI,CAACnD,OAAO,CAACoD,SAAS,EACtB,IAAI,CAACpD,OAAO,CAACqD,SAAS,EAKzB,IAAI,CAACpB,IAAI,CAAEU,QAAQ,CAC1B,yCACF,CAAC,EACOW,yBAAyB,EACxB,IAAI,CAACC,OAAO;MAM/B;IAAC;MAAAtE,IAAA;MAAAG,GAAA;MAAAC,KAAA,EAED,SAAAmE,aAAuBC,YAA4B,EAAE;QAAA,IAAAC,cAAA,EAAAC,cAAA;QACnD,IAAI,CAACF,YAAY,CAACG,GAAG,CAAC,MAAM,CAAC,IAAIH,YAAY,CAACI,IAAI,GAAG,CAAC,EAAE;UACtD,OAAO,IAAI;QACb;QAEA,IAAMC,OAAO,GAAGL,YAAY,CAACM,GAAG,CAAC,MAAM,CAA8B;QAErE,IAAI,CAACD,OAAO,IAAI,CAAC,IAAI,CAAC7D,eAAe,EAAE;UACrC,OAAO,IAAI;QACb;QAEA,IAAI6D,OAAO,CAACE,MAAM,CAACC,QAAQ,KAAK,IAAI,CAAChC,IAAI,CAAC+B,MAAM,CAACC,QAAQ,EAAE;UACzD,OAAO,IAAI;QACb;QAEA,IAAIR,YAAY,CAACG,GAAG,CAAC,eAAe,CAAC,EAAE;UACrC,OAAO,IAAI;QACb;QAEA,KAAAF,cAAA,GAAI,IAAI,CAAC1D,OAAO,cAAA0D,cAAA,eAAZA,cAAA,CAAc5D,oBAAoB,EAAE;UACtC,IAAIgE,OAAO,CAACI,MAAM,KAAK,IAAI,CAACjC,IAAI,CAACiC,MAAM,EAAE;YACvC,OAAO,IAAI;UACb;QACF;QAEA,OAAO,CAAAP,cAAA,OAAI,CAAC3D,OAAO,cAAA2D,cAAA,eAAZA,cAAA,CAAc9D,QAAQ,GACzBrC,0BAA0B,CAAC,IAAI,EAAEiG,YAAY,CAAC,GAC9ClG,gBAAgB,CAAC,IAAI,EAAEkG,YAAY,CAAC;MAC1C;IAAC;MAAAxE,IAAA;MAAAG,GAAA;MAAAC,KAAA,EAED,SAAA8E,WAAqBV,YAA4B,EAAQ;QAAA,IAAAW,cAAA,EAAAC,iBAAA;QACvDC,IAAA,CAAAC,eAAA,CA9JE1G,UAAU,CAAA2G,SAAA,uBAAAC,IAAA,OA8JKhB,YAAY;QAC7B,IACEA,YAAY,CAACG,GAAG,CAAC,MAAM,CAAC,KAAAQ,cAAA,GACxB,IAAI,CAACpE,OAAO,cAAAoE,cAAA,eAAZA,cAAA,CAActE,oBAAoB,IAClC,CAAC1C,SAAS,CACR,IAAI,CAACsH,kBAAkB,EAAAL,iBAAA,GAACZ,YAAY,CAACM,GAAG,CAAC,MAAM,CAAC,cAAAM,iBAAA,uBAAxBA,iBAAA,CAA0BH,MAAM,CAAC,EACzD,IAAI,CAACQ,kBAAkB,CAAC,IAAI,CAACzC,IAAI,CAACiC,MAAM,CAC1C,CAAC,EACD;UACA,IAAI,CAAChE,YAAY,GAAG,IAAI,CAACC,eAAe,CAAC,CAAC;QAC5C;MACF;IAAC;MAAAlB,IAAA;MAAAG,GAAA;MAAAC,KAAA,EAED,SAAAsF,kBAAA,EAA2B;QAAA,IAAAC,qBAAA;QACzBN,IAAA,CAAAC,eAAA,CA5KE1G,UAAU,CAAA2G,SAAA,8BAAAC,IAAA;QA6KZ,IAAI,IAAI,CAACI,UAAU,KAAAD,qBAAA,GAAI,IAAI,CAAC3E,eAAe,cAAA2E,qBAAA,eAApBA,qBAAA,CAAsBrG,MAAM,EAAE;UACnD,IAAI,CAACuG,iBAAiB,CAAC,CAAC;QAC1B;MACF;IAAC;MAAA7F,IAAA;MAAAG,GAAA;MAAAC,KAAA,EAED,SAAA0F,qBAAA,EAA8B;QAC5BT,IAAA,CAAAC,eAAA,CAnLE1G,UAAU,CAAA2G,SAAA,iCAAAC,IAAA;QAoLZ,IAAI,CAACO,mBAAmB,CAAC,CAAC;MAC5B;IAAC;MAAA/F,IAAA;MAAAG,GAAA;MAAAC,KAAA,EAED,SAAAyF,kBAAA,EAA4B;QAAA,IAAAG,qBAAA;UAAAC,cAAA;UAAAC,MAAA;UAAAC,IAAA;QAC1B,IACE,CAACnI,iBAAiB,CAAC,IAAI,CAACgF,IAAI,EAAG,SAAS,CAAC,IACzC,IAAI,CAACoD,WAAW,IAChB,GAAAJ,qBAAA,IAAAC,cAAA,GAAE,IAAI,CAAClF,OAAO,cAAAkF,cAAA,uBAAZA,cAAA,CAAcI,aAAa,cAAAL,qBAAA,cAAAA,qBAAA,GAAItH,qBAAqB,CAAC,EACvD;UACA;QACF;QACA,IAAI,CAAC0H,WAAW,GAAG/H,gCAAgC,CACjD,IAAI,CAAC2E,IAAI,EACT,UAACsD,eAAe,EAAK;UACnB,IAAI,CAACJ,MAAI,CAACE,WAAW,EAAE;YACrB;YACA;UACF;UACAF,MAAI,CAACjC,aAAa,GAAGqC,eAAe;QACtC,CAAC,GAAAH,IAAA,GACD,IAAI,CAACpF,OAAO,CAAEsF,aAAa,cAAAF,IAAA,cAAAA,IAAA,GAAKzH,qBAAqB,EACrD,CAAC,IAAI,CAACsC,eAAe,IAAI,EAAE,EAAEuF,GAAG,CAAC,UAACC,MAAM;UAAA,OAAKA,MAAM,CAACA,MAAM;QAAA,EAAC,EAC3D,KAAK,EACL,KAAK,EACL,KACF,CAAC,CAACC,KAAK,CAAC,UAACC,GAAG,EAAK;UACfR,MAAI,CAACE,WAAW,GAAGO,SAAS;UAC5BT,MAAI,CAAC3C,MAAM,GAAGmD,GAAG;QACnB,CAAC,CAAC;MACJ;IAAC;MAAA1G,IAAA;MAAAG,GAAA;MAAAC,KAAA,EAED,SAAA2F,oBAAA,EAA8B;QAC5B,IAAI,IAAI,CAACK,WAAW,EAAE;UACpB,IAAI,CAACA,WAAW,CAACQ,IAAI,CAAC,UAACC,KAAK;YAAA,OAAKA,KAAK,aAALA,KAAK,uBAALA,KAAK,CAAG,CAAC;UAAA,EAAC;UAC3C,IAAI,CAACT,WAAW,GAAGO,SAAS;QAC9B;MACF;IAAC;MAAA3G,IAAA;MAAAG,GAAA;MAAAC,KAAA,EAED,SAAA0G,QAAkBtC,YAA4B,EAAQ;QAAA,IAAAuC,sBAAA;QACpD,KAAAA,sBAAA,GAAI,IAAI,CAAC/F,eAAe,cAAA+F,sBAAA,eAApBA,sBAAA,CAAsBzH,MAAM,EAAE;UAChC,IAAI,CAAC,IAAI,CAAC8G,WAAW,IAAI5B,YAAY,CAACG,GAAG,CAAC,SAAS,CAAC,EAAE;YACpD,IAAI,CAACoB,mBAAmB,CAAC,CAAC;YAC1B,IAAI,CAACF,iBAAiB,CAAC,CAAC;UAC1B;QACF,CAAC,MAAM;UACL,IAAI,CAACE,mBAAmB,CAAC,CAAC;QAC5B;QACA,IAAIvB,YAAY,CAACG,GAAG,CAAC,SAAS,CAAC,EAAE;UAC/B,IAAI,CAACqC,eAAe,CAAC,CAAC;QACxB;MACF;IAAC;MAAAhH,IAAA;MAAAG,GAAA;MAAAC,KAAA,EAED,SAAA4G,gBAAA,EAAgC;QAC9B,IAAMC,IAAI,GAAG,IAAI,CAACC,UAAU,CAAEC,cAAc,CAAC,MAAM,CAAC;QACpD,IAAI,CAAC,IAAI,CAACpG,OAAO,IAAI,IAAI,CAACqG,OAAO,IAAI,CAACH,IAAI,EAAE;UAC1C;QACF;QAEA,IAAI,CAAC,IAAI,CAAClG,OAAO,CAACM,YAAY,EAAE;UAC9B4F,IAAI,CAACI,KAAK,CAACC,aAAa,GAAG,MAAM;UACjC;QACF;QAEAL,IAAI,CAACI,KAAK,CAACE,MAAM,GAAG,MAAM;QAE1B,IAAMjG,KAAK,GAAGlD,gBAAgB,CAAC,IAAI,CAAC2C,OAAO,CAACM,YAAY,CAAC;QAEzD4F,IAAI,CAACI,KAAK,CAACC,aAAa,GACtBhG,KAAK,IAAIA,KAAK,CAACE,CAAC,GAAG,CAAC,IAAIF,KAAK,CAACG,CAAC,GAAG,CAAC,MAAA9B,MAAA,CAC5B,CAAE,GAAG,GAAG2B,KAAK,CAACG,CAAC,GAAIH,KAAK,CAACE,CAAC,EAAEE,OAAO,CAAC,CAAC,CAAC,SACxCuF,IAAI,CAACI,KAAK,CAACC,aAAa,GAAG,MAAO;MAC3C;IAAC;MAAAtH,IAAA;MAAAG,GAAA;MAAAC,KAAA,EAED,SAAAkE,QAAA,EAAkB;QAAA,IAAAkD,UAAA;QAChB,CAAAA,UAAA,OAAI,CAACC,IAAI,cAAAD,UAAA,eAATA,UAAA,CAAWE,MAAM,CAAC,CAAC;MACrB;IAAC;MAAA1H,IAAA;MAAAG,GAAA;MAAAC,KAAA,EAED,SAAAuH,UAAkBC,QAAgB,EAAU;QAC1C,IAAIC,KAAK,GAAG,IAAI,CAACC,UAAU,CAACF,QAAQ,CAAC;QACrC,IAAIC,KAAK,EAAE;UACT,OAAOA,KAAK;QACd;QACAA,KAAK,GAAG9J,eAAe,CAAC,IAAI,CAACgK,WAAW,CAAC;QACzC,IAAI,CAACA,WAAW,EAAE;QAClB,IAAI,CAACD,UAAU,CAACF,QAAQ,CAAC,GAAGC,KAAK;QACjC,OAAOA,KAAK;MACd;IAAC;MAAA7H,IAAA;MAAAG,GAAA;MAAAC,KAAA,EAED,SAAAqF,mBAA2BR,MAAqB,EAAY;QAAA,IAAA+C,cAAA;QAC1D,IAAI,CAAC/C,MAAM,IAAI,GAAA+C,cAAA,GAAC,IAAI,CAACjH,OAAO,cAAAiH,cAAA,eAAZA,cAAA,CAAcnH,oBAAoB,GAAE;UAClD,OAAO,EAAE;QACX;QAEA,IAAMoH,WAAqB,GAAG,EAAE;QAChC;QACA,IAAMC,WAAW,GAAG,IAAI,CAACnH,OAAO,CAACF,oBAAoB,CAACsH,QAAQ,CAAC,KAAK,CAAC;QACrE,SAAAC,EAAA,MAAAC,cAAA,GAAuBC,MAAM,CAACC,MAAM,CAACtD,MAAM,CAAC,EAAAmD,EAAA,GAAAC,cAAA,CAAA/I,MAAA,EAAA8I,EAAA,IAAE;UAAzC,IAAMI,QAAQ,GAAAH,cAAA,CAAAD,EAAA;UACjB,IACEnK,aAAa,CAACuK,QAAQ,CAACC,SAAS,CAAC,KAAK,cAAc,KACnDP,WAAW,IACV,IAAI,CAACnH,OAAO,CAACF,oBAAoB,CAACsH,QAAQ,CACxCK,QAAQ,CAACE,UAAU,CAACC,MACtB,CAAC,CAAC,EACJ;YACAV,WAAW,CAACW,IAAI,CAACJ,QAAQ,CAACC,SAAS,CAAC;UACtC;QACF;QACA,OAAOR,WAAW;MACpB;IAAC;MAAAjI,IAAA;MAAAG,GAAA;MAAAC,KAAA,EAED,SAAAc,gBAAA,EAAyC;QAAA,IAAA2H,MAAA;UAAAC,UAAA;QACvC,UAAAnJ,MAAA,CAAAoJ,kBAAA,CACK,CAAC,IAAI,CAAC/H,eAAe,IAAI,EAAE,EAAEuF,GAAG,CAAC,UAACyC,UAAU;UAAA,OAAM;YACnDP,SAAS,EAAEO,UAAU,CAACxC,MAAM;YAC5BqB,KAAK,EAAEgB,MAAI,CAAClB,SAAS,CAACqB,UAAU,CAACxC,MAAM,CAAC;YACxCyC,UAAU,EAAED,UAAU,CAACC,UAAU;YACjCC,KAAK,EAAEF,UAAU,CAACE,KAAK;YACvBC,IAAI,EAAEH,UAAU,CAACG;UACnB,CAAC;QAAA,CAAC,CAAC,GAAAJ,kBAAA,CACA,IAAI,CAACtD,kBAAkB,EAAAqD,UAAA,GAAC,IAAI,CAAC9F,IAAI,cAAA8F,UAAA,uBAATA,UAAA,CAAW7D,MAAM,CAAC,CAACsB,GAAG,CAAC,UAACC,MAAM;UAAA,OAAM;YAC7DiC,SAAS,EAAEjC,MAAM;YACjBqB,KAAK,EAAEgB,MAAI,CAAClB,SAAS,CAACnB,MAAM;UAC9B,CAAC;QAAA,CAAC,CAAC;MAEP;IAAC;MAAAxG,IAAA;MAAAG,GAAA;MAAAC,KAAA,WAAAA,MAAA;QAAA,IAAAgJ,MAAA;QAAA,OAE0BtL,UAAU,CACnC,UACE2C,MAAqB,EACrB4I,OAAuB,EACM;UAAA,IAAAC,qBAAA;UAC7B,IAAI,CAACD,OAAO,IAAI,GAAAC,qBAAA,GAAE7I,MAAM,CAAC4F,aAAa,cAAAiD,qBAAA,cAAAA,qBAAA,GAAI5K,qBAAqB,CAAC,EAAE;YAChE,OAAOiI,SAAS;UAClB;UAEA,IAAM4C,KAAmB,GAAG,EAAE;UAAC,IAAAC,KAAA,YAAAA,MAAA,EAEc;cAAA,IAAAC,qBAAA,EAAAC,kBAAA,EAAAC,sBAAA;cAAxC,IAAM/B,QAAQ,GAAAgC,YAAA,CAAAC,GAAA;cACjB,IAAI5L,aAAa,CAAC2J,QAAQ,CAAC,KAAK,MAAM,EAAE;gBAAA;cAExC;cACA,IAAMkC,YAAY,GAAGT,OAAO,CAACzB,QAAQ,CAAC;cACtC,IAAI,EAACkC,YAAY,aAAZA,YAAY,eAAZA,YAAY,CAAExK,MAAM,GAAE;gBAAA;cAE3B;cACA;cACA,IAAMyK,MAAwB,GAAG,EAAE;cAAC,IAAAC,SAAA,GAAAC,0BAAA,CACVH,YAAY;gBAAAI,KAAA;cAAA;gBAAtC,KAAAF,SAAA,CAAAG,CAAA,MAAAD,KAAA,GAAAF,SAAA,CAAAI,CAAA,IAAAC,IAAA,GAAwC;kBAAA,IAA7BC,WAAW,GAAAJ,KAAA,CAAA9J,KAAA;kBACpB,IAAMmK,QAAQ,GAAGD,WAAW,CAACE,CAAC,CAACD,QAAQ;kBACvC,IAAME,SAAS,GAAGH,WAAW,CAACE,CAAC,CAACC,SAAS;kBACzC,IAAI,CAACF,QAAQ,IAAI,CAACE,SAAS,EAAE;oBAC3B;kBACF;kBACA,IAAMC,CAAC,GAAG,CAAC,CAAmB;kBAC9BA,CAAC,CAACC,KAAK,GAAG,CAACJ,QAAQ,EAAEE,SAAS,CAAgB;kBAC9CC,CAAC,CAACE,SAAS,GAAG,IAAIC,IAAI,CAACP,WAAW,CAACQ,EAAE,GAAG,IAAI,CAAC;kBAC7Cf,MAAM,CAACnB,IAAI,CAAC8B,CAAC,CAAC;gBAChB;cAAC,SAAAhE,GAAA;gBAAAsD,SAAA,CAAAe,CAAA,CAAArE,GAAA;cAAA;gBAAAsD,SAAA,CAAAgB,CAAA;cAAA;cAED,IAAMC,YAAY,IAAAxB,qBAAA,GAAGL,MAAI,CAACpI,eAAe,cAAAyI,qBAAA,uBAApBA,qBAAA,CAAsByB,IAAI,CAC7C,UAACH,CAAC;gBAAA,OAAKA,CAAC,CAACvE,MAAM,KAAKoB,QAAQ;cAAA,CAC9B,CAAC;cACD,IAAMuB,IAAI,IAAAO,kBAAA,GACRuB,YAAY,aAAZA,YAAY,uBAAZA,YAAY,CAAE9B,IAAI,cAAAO,kBAAA,cAAAA,kBAAA,GACjB9B,QAAQ,IAAIwB,MAAI,CAACpG,IAAI,CAACiC,MAAM,GACzB/G,gBAAgB,CAACkL,MAAI,CAACpG,IAAI,CAACiC,MAAM,CAAC2C,QAAQ,CAAC,CAAC,GAC5CA,QAAS;cAEf2B,KAAK,CAACX,IAAI,CAAC;gBACTmB,MAAM,EAANA,MAAM;gBACNZ,IAAI,EAAJA,IAAI;gBACJgC,YAAY,EAAE,EAAAxB,sBAAA,GAAClJ,MAAM,CAAC4F,aAAa,cAAAsD,sBAAA,cAAAA,sBAAA,GAAIjL,qBAAqB,IAAI,GAAG;gBACnEmJ,KAAK,EAAEuB,MAAI,CAACzB,SAAS,CAACC,QAAQ,CAAC;gBAC/BwD,cAAc,EAAE;cAClB,CAAC,CAAC;YACJ,CAAC;YAAAC,IAAA;UAtCD,SAAAxB,GAAA,MAAAD,YAAA,GAAuBtB,MAAM,CAACgD,IAAI,CAACjC,OAAO,CAAC,EAAAQ,GAAA,GAAAD,YAAA,CAAAtK,MAAA,EAAAuK,GAAA;YAAAwB,IAAA,GAAA7B,KAAA;YAAA,IAAA6B,IAAA,QAEvC;UAAS;UAqCb,OAAO9B,KAAK;QACd,CACF,CAAC;MAAA;IAAA;MAAAvJ,IAAA;MAAA8B,MAAA;MAAA3B,GAAA;MAAAC,KAAA,EAED,SAAAmL,OAAA,EAAoC;QAClC,OAAOjO,GAAG,CAAAkO,gBAAA,KAAAA,gBAAA,GAAA/H,sBAAA;MAgCZ;IAAC;EAAA;AAAA,GAzYsBjG,UAAU"},"metadata":{},"sourceType":"module","externalDependencies":[]}