{"ast":null,"code":"import { getColorByIndex } from \"../common/color/colors\";\nimport { computeDomain } from \"../common/entity/compute_domain\";\nimport { computeStateName } from \"../common/entity/compute_state_name\";\nimport { isUnavailableState } from \"./entity\";\n\n/** Object used to render a calendar event in fullcalendar. */\n\n/** Data returned from the core APIs. */\n\n// The scope of a delete/update for a recurring event\nexport let RecurrenceRange = /*#__PURE__*/function (RecurrenceRange) {\n  RecurrenceRange[\"THISEVENT\"] = \"\";\n  RecurrenceRange[\"THISANDFUTURE\"] = \"THISANDFUTURE\";\n  return RecurrenceRange;\n}({});\nexport let CalendarEntityFeature = /*#__PURE__*/function (CalendarEntityFeature) {\n  CalendarEntityFeature[CalendarEntityFeature[\"CREATE_EVENT\"] = 1] = \"CREATE_EVENT\";\n  CalendarEntityFeature[CalendarEntityFeature[\"DELETE_EVENT\"] = 2] = \"DELETE_EVENT\";\n  CalendarEntityFeature[CalendarEntityFeature[\"UPDATE_EVENT\"] = 4] = \"UPDATE_EVENT\";\n  return CalendarEntityFeature;\n}({});\nexport const fetchCalendarEvents = async (hass, start, end, calendars) => {\n  const params = encodeURI(`?start=${start.toISOString()}&end=${end.toISOString()}`);\n  const calEvents = [];\n  const errors = [];\n  const promises = [];\n  calendars.forEach(cal => {\n    promises.push(hass.callApi(\"GET\", `calendars/${cal.entity_id}${params}`));\n  });\n  for (const [idx, promise] of promises.entries()) {\n    let result;\n    try {\n      // eslint-disable-next-line no-await-in-loop\n      result = await promise;\n    } catch (err) {\n      errors.push(calendars[idx].entity_id);\n      continue;\n    }\n    const cal = calendars[idx];\n    result.forEach(ev => {\n      const eventStart = getCalendarDate(ev.start);\n      const eventEnd = getCalendarDate(ev.end);\n      if (!eventStart || !eventEnd) {\n        return;\n      }\n      const eventData = {\n        uid: ev.uid,\n        summary: ev.summary,\n        description: ev.description,\n        dtstart: eventStart,\n        dtend: eventEnd,\n        recurrence_id: ev.recurrence_id,\n        rrule: ev.rrule\n      };\n      const event = {\n        start: eventStart,\n        end: eventEnd,\n        title: ev.summary,\n        backgroundColor: cal.backgroundColor,\n        borderColor: cal.backgroundColor,\n        calendar: cal.entity_id,\n        eventData: eventData\n      };\n      calEvents.push(event);\n    });\n  }\n  return {\n    events: calEvents,\n    errors\n  };\n};\nconst getCalendarDate = dateObj => {\n  if (typeof dateObj === \"string\") {\n    return dateObj;\n  }\n  if (dateObj.dateTime) {\n    return dateObj.dateTime;\n  }\n  if (dateObj.date) {\n    return dateObj.date;\n  }\n  return undefined;\n};\nexport const getCalendars = hass => Object.keys(hass.states).filter(eid => {\n  var _hass$entities$eid;\n  return computeDomain(eid) === \"calendar\" && !isUnavailableState(hass.states[eid].state) && ((_hass$entities$eid = hass.entities[eid]) === null || _hass$entities$eid === void 0 ? void 0 : _hass$entities$eid.hidden) !== true;\n}).sort().map((eid, idx) => ({\n  ...hass.states[eid],\n  name: computeStateName(hass.states[eid]),\n  backgroundColor: getColorByIndex(idx)\n}));\nexport const createCalendarEvent = (hass, entityId, event) => hass.callWS({\n  type: \"calendar/event/create\",\n  entity_id: entityId,\n  event: event\n});\nexport const updateCalendarEvent = (hass, entityId, uid, event, recurrence_id, recurrence_range) => hass.callWS({\n  type: \"calendar/event/update\",\n  entity_id: entityId,\n  uid,\n  recurrence_id,\n  recurrence_range,\n  event\n});\nexport const deleteCalendarEvent = (hass, entityId, uid, recurrence_id, recurrence_range) => hass.callWS({\n  type: \"calendar/event/delete\",\n  entity_id: entityId,\n  uid,\n  recurrence_id,\n  recurrence_range\n});","map":{"version":3,"names":["getColorByIndex","computeDomain","computeStateName","isUnavailableState","RecurrenceRange","CalendarEntityFeature","fetchCalendarEvents","hass","start","end","calendars","params","encodeURI","toISOString","calEvents","errors","promises","forEach","cal","push","callApi","entity_id","idx","promise","entries","result","err","ev","eventStart","getCalendarDate","eventEnd","eventData","uid","summary","description","dtstart","dtend","recurrence_id","rrule","event","title","backgroundColor","borderColor","calendar","events","dateObj","dateTime","date","undefined","getCalendars","Object","keys","states","filter","eid","_hass$entities$eid","state","entities","hidden","sort","map","name","createCalendarEvent","entityId","callWS","type","updateCalendarEvent","recurrence_range","deleteCalendarEvent"],"sources":["/workspaces/frontend/src/data/calendar.ts"],"sourcesContent":["import { getColorByIndex } from \"../common/color/colors\";\nimport { computeDomain } from \"../common/entity/compute_domain\";\nimport { computeStateName } from \"../common/entity/compute_state_name\";\nimport type { HomeAssistant } from \"../types\";\nimport { isUnavailableState } from \"./entity\";\n\nexport interface Calendar {\n  entity_id: string;\n  name?: string;\n  backgroundColor?: string;\n}\n\n/** Object used to render a calendar event in fullcalendar. */\nexport interface CalendarEvent {\n  title: string;\n  start: string;\n  end?: string;\n  backgroundColor?: string;\n  borderColor?: string;\n  calendar: string;\n  eventData: CalendarEventData;\n  [key: string]: any;\n}\n\n/** Data returned from the core APIs. */\nexport interface CalendarEventData {\n  uid?: string;\n  recurrence_id?: string;\n  summary: string;\n  dtstart: string;\n  dtend: string;\n  rrule?: string;\n  description?: string;\n}\n\nexport interface CalendarEventMutableParams {\n  summary: string;\n  dtstart: string;\n  dtend: string;\n  rrule?: string;\n  description?: string;\n}\n\n// The scope of a delete/update for a recurring event\nexport enum RecurrenceRange {\n  THISEVENT = \"\",\n  THISANDFUTURE = \"THISANDFUTURE\",\n}\n\nexport const enum CalendarEntityFeature {\n  CREATE_EVENT = 1,\n  DELETE_EVENT = 2,\n  UPDATE_EVENT = 4,\n}\n\nexport const fetchCalendarEvents = async (\n  hass: HomeAssistant,\n  start: Date,\n  end: Date,\n  calendars: Calendar[]\n): Promise<{ events: CalendarEvent[]; errors: string[] }> => {\n  const params = encodeURI(\n    `?start=${start.toISOString()}&end=${end.toISOString()}`\n  );\n\n  const calEvents: CalendarEvent[] = [];\n  const errors: string[] = [];\n  const promises: Promise<CalendarEvent[]>[] = [];\n\n  calendars.forEach((cal) => {\n    promises.push(\n      hass.callApi<CalendarEvent[]>(\n        \"GET\",\n        `calendars/${cal.entity_id}${params}`\n      )\n    );\n  });\n\n  for (const [idx, promise] of promises.entries()) {\n    let result: CalendarEvent[];\n    try {\n      // eslint-disable-next-line no-await-in-loop\n      result = await promise;\n    } catch (err) {\n      errors.push(calendars[idx].entity_id);\n      continue;\n    }\n    const cal = calendars[idx];\n    result.forEach((ev) => {\n      const eventStart = getCalendarDate(ev.start);\n      const eventEnd = getCalendarDate(ev.end);\n      if (!eventStart || !eventEnd) {\n        return;\n      }\n      const eventData: CalendarEventData = {\n        uid: ev.uid,\n        summary: ev.summary,\n        description: ev.description,\n        dtstart: eventStart,\n        dtend: eventEnd,\n        recurrence_id: ev.recurrence_id,\n        rrule: ev.rrule,\n      };\n      const event: CalendarEvent = {\n        start: eventStart,\n        end: eventEnd,\n        title: ev.summary,\n        backgroundColor: cal.backgroundColor,\n        borderColor: cal.backgroundColor,\n        calendar: cal.entity_id,\n        eventData: eventData,\n      };\n\n      calEvents.push(event);\n    });\n  }\n\n  return { events: calEvents, errors };\n};\n\nconst getCalendarDate = (dateObj: any): string | undefined => {\n  if (typeof dateObj === \"string\") {\n    return dateObj;\n  }\n\n  if (dateObj.dateTime) {\n    return dateObj.dateTime;\n  }\n\n  if (dateObj.date) {\n    return dateObj.date;\n  }\n\n  return undefined;\n};\n\nexport const getCalendars = (hass: HomeAssistant): Calendar[] =>\n  Object.keys(hass.states)\n    .filter(\n      (eid) =>\n        computeDomain(eid) === \"calendar\" &&\n        !isUnavailableState(hass.states[eid].state) &&\n        hass.entities[eid]?.hidden !== true\n    )\n    .sort()\n    .map((eid, idx) => ({\n      ...hass.states[eid],\n      name: computeStateName(hass.states[eid]),\n      backgroundColor: getColorByIndex(idx),\n    }));\n\nexport const createCalendarEvent = (\n  hass: HomeAssistant,\n  entityId: string,\n  event: CalendarEventMutableParams\n) =>\n  hass.callWS<void>({\n    type: \"calendar/event/create\",\n    entity_id: entityId,\n    event: event,\n  });\n\nexport const updateCalendarEvent = (\n  hass: HomeAssistant,\n  entityId: string,\n  uid: string,\n  event: CalendarEventMutableParams,\n  recurrence_id?: string,\n  recurrence_range?: RecurrenceRange\n) =>\n  hass.callWS<void>({\n    type: \"calendar/event/update\",\n    entity_id: entityId,\n    uid,\n    recurrence_id,\n    recurrence_range,\n    event,\n  });\n\nexport const deleteCalendarEvent = (\n  hass: HomeAssistant,\n  entityId: string,\n  uid: string,\n  recurrence_id?: string,\n  recurrence_range?: RecurrenceRange\n) =>\n  hass.callWS<void>({\n    type: \"calendar/event/delete\",\n    entity_id: entityId,\n    uid,\n    recurrence_id,\n    recurrence_range,\n  });\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}