#!/usr/bin/env node
"use strict";var O=Object.defineProperty;var N=(e,t,r)=>t in e?O(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var E=(e,t,r)=>(N(e,typeof t!="symbol"?t+"":t,r),r),x=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)};var R=(e,t,r)=>(x(e,t,"read from private field"),r?r.call(e):t.get(e)),$=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},k=(e,t,r,i)=>(x(e,t,"write to private field"),i?i.call(e,r):t.set(e,r),r);var d,Ee=require("module"),U=require("mocha/lib/cli/run.js"),V=require("mocha/lib/cli/options.js"),B=require("yargs/yargs"),Q=require("path"),z=require("assert"),D=require("mocha/lib/cli/collect-files.js"),H=require("os"),J=require("mocha"),K=require("mocha/lib/suite.js"),q=require("memfs"),G=require("fs-require"),X=require("@cspotcode/source-map-support"),Y=require("webpack"),Z=require("fs"),ee=require("url");function s(e){return e&&typeof e=="object"&&"default"in e?e:{default:e}}var S=s(U),te=s(B),b=s(Q),F=s(z),re=s(D),T=s(H),ne=s(J),v=s(K),ae=s(X),j=s(Y),ie=s(Z),u=require;function oe(e,t=1,r={}){const{indent:i=" ",includeEmptyLines:n=!1}=r;if(typeof e!="string")throw new TypeError(`Expected \`input\` to be a \`string\`, got \`${typeof e}\``);if(typeof t!="number")throw new TypeError(`Expected \`count\` to be a \`number\`, got \`${typeof t}\``);if(t<0)throw new RangeError(`Expected \`count\` to be at least 0, got \`${t}\``);if(typeof i!="string")throw new TypeError(`Expected \`options.indent\` to be a \`string\`, got \`${typeof i}\``);if(t===0)return e;const a=n?/^/gm:/^(?!\s*$)/gm;return e.replace(a,i.repeat(t))}function se(e){if(typeof e!="string")throw new TypeError("Expected a string");return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d")}const I=/\s+at.*[(\s](.*)\)?/,ce=/^(?:(?:(?:node|node:[\w/]+|(?:(?:node:)?internal\/[\w/]*|.*node_modules\/(?:babel-polyfill|pirates)\/.*)?\w+)(?:\.js)?:\d+:\d+)|native)/,ue=typeof T.default.homedir=="undefined"?"":T.default.homedir().replace(/\\/g,"/");function le(e,{pretty:t=!1,basePath:r}={}){const i=r&&new RegExp(`(at | \\()${se(r.replace(/\\/g,"/"))}`,"g");if(typeof e=="string")return e.replace(/\\/g,"/").split(`
`).filter(n=>{const a=n.match(I);if(a===null||!a[1])return!0;const o=a[1];return o.includes(".app/Contents/Resources/electron.asar")||o.includes(".app/Contents/Resources/default_app.asar")||o.includes("node_modules/electron/dist/resources/electron.asar")||o.includes("node_modules/electron/dist/resources/default_app.asar")?!1:!ce.test(o)}).filter(n=>n.trim()!=="").map(n=>(i&&(n=n.replace(i,"$1")),t&&(n=n.replace(I,(a,o)=>a.replace(o,o.replace(ue,"~")))),n)).join(`
`)}const pe=e=>e.replace(/\s+at .*aggregate-error\/index.js:\d+:\d+\)?/g,"");class M extends Error{constructor(r){if(!Array.isArray(r))throw new TypeError(`Expected input to be an Array, got ${typeof r}`);r=r.map(n=>n instanceof Error?n:n!==null&&typeof n=="object"?Object.assign(new Error(n.message),n):new Error(n));let i=r.map(n=>typeof n.stack=="string"&&n.stack.length>0?pe(le(n.stack)):String(n)).join(`
`);i=`
`+oe(i,4);super(i);$(this,d,void 0);E(this,"name","AggregateError");k(this,d,r)}get errors(){return R(this,d).slice()}}d=new WeakMap;const f=q.createFsFromVolume(new q.Volume);f.join=b.default.join;let W;const fe=e=>{const t=G.createFsRequire(f,{fs:!0});return W=t.id,t(e)};ae.default.install({environment:"node",retrieveFile(e){const t=`fs-require://${W}/`;if(e.startsWith(t)&&(e=e.slice(t.length-1)),f.existsSync(e))return f.readFileSync(e).toString()}});function de(e){const t=new ne.default(e);function r(){return new Promise(i=>{this.run.call(this,i)})}return t.$run=r,t.loadFilesAsync=async function(){const{suite:n,files:a}=this;this.lazyLoadFiles(!0);for(let o of a)o=b.default.posix.resolve(o),n.emit(v.default.constants.EVENT_FILE_PRE_REQUIRE,global,o,this),n.emit(v.default.constants.EVENT_FILE_REQUIRE,await fe(o),o,this),n.emit(v.default.constants.EVENT_FILE_POST_REQUIRE,global,o,this)},t}async function P(e){const t=de(e);return t.files=["/main.js"],await t.loadFilesAsync(),await t.$run()}function ge(e,t){var r,i,n;const a={...e};if(a.entry=t,a.output={...e.output,path:"/",publicPath:"",filename:"main.js",globalObject:"this",libraryTarget:"commonjs2"},(r=a.optimization)!=null&&r.runtimeChunk&&(a.optimization.runtimeChunk=void 0),!Array.isArray(a.externals)){const{externals:l}=a;a.externals=[],l&&a.externals.push(l)}if(((i=j.default.version)==null?void 0:i.split(".")[0])>"4")a.externalsPresets||(a.externalsPresets={}),a.externalsPresets.node=!0,Object.assign(a.output,{chunkLoading:"require",chunkFormat:"commonjs"});else{const l=u("webpack/lib/LoaderTargetPlugin"),g=u("webpack/lib/FunctionModulePlugin"),m=u("webpack/lib/node/NodeTemplatePlugin"),c=u("webpack/lib/node/ReadFileCompileWasmTemplatePlugin"),y=u("webpack/lib/node/NodeTargetPlugin"),L=(n=a.target)!=null?n:"web";a.target=p=>{new m().apply(p),new c(a.output).apply(p),new g(a.output).apply(p),new y().apply(p),new l(L).apply(p)}}const o=j.default(a);o.outputFileSystem=f;function w(){return new Promise((l,g)=>{this.run((m,c)=>{if(m){g(m);return}if(c.hasErrors()){g(new M(c.compilation.errors));return}if(c.hasWarnings())for(const y of c.compilation.warnings)console.log(y);l(c)})})}return o.$run=w,o}function me(e){return new Function("id","return import(id);")(e)}async function he(e){try{return u(e)}catch(t){if(t.code==="ERR_REQUIRE_ESM"){process.platform==="win32"&&(e=ee.pathToFileURL(e).href);const{default:r}=await me(e);return r}throw new Error(`Faild to load Webpack configuration: ${e}`)}}async function we(e,t){F.default(ie.default.existsSync(e),`Invalid Webpack configuration path: ${e}`);const r=await he(e);if(typeof r=="function"){const i={};t.watch?i.WEBPACK_WATCH=!0:i.WEBPACK_BUILD=!0;const n={env:i};return t.mode&&(n.mode=t.mode),t.watch&&(n.watch=t.watch),r(i,n)}return t.mode&&(r.mode=t.mode),r}const h="\x1B[",A=`${h}2J`,ye=process.platform==="win32"?`${A}${h}0f`:`${A}${h}3J${h}H`;async function be(e){F.default(e.webpackConfig,"Webpack configuration path must be passed in");const t=b.default.resolve(e.webpackConfig),r=await we(t,e),i=re.default({ignore:[],file:[],...e});e.watch&&(r.plugins||(r.plugins=[]),r.plugins.unshift({apply(a){a.hooks.watchRun.tap("InstantMocha",()=>{process.stdout.write(ye)})}}));const n=ge(r,i);if(e.watch)n.watch({},(a,o)=>{if(a){console.log(a);return}if(o.hasErrors()){console.log(new M(o.compilation.errors));return}if(o.hasWarnings())for(const w of o.compilation.warnings)console.log(w);setImmediate(()=>{P(e)})});else return await n.$run(),await P(e)}const{version:ve}=u("../package.json"),_="instant-mocha options",C=V.loadOptions(process.argv.slice(2));te.default().scriptName("instant-mocha").command({...S.default,command:["$0 [spec..]"],describe:"Build tests with Webpack and run them with Mocha",builder(e){const t=new Set(["watch","watch-files","watch-ignore"]),r=Object.assign(Object.create(e),{options(i){const n={};for(const a in i)t.has(a)||(n[a]=i[a]);return e.options.call(this,n)}});S.default.builder(r)},async handler(e){try{await be(e)>0&&process.exit(1)}catch(t){console.error(t),process.exit(1)}}}).options({"webpack-config":{description:"Path to Webpack configuration",group:_,type:"string",default:"webpack.config.js"},watch:{description:"Watch mode",group:_},mode:{description:"Mode passed to webpack development|production",group:_,type:"string",alias:"m"}}).help("help","Show usage information & exit").alias("help","h").version("version","Show version number & exit",ve).alias("version","V").wrap(process.stdout.columns?Math.min(process.stdout.columns,80):80).config(C).parse(C._);
